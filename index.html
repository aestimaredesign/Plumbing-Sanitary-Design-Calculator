<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Plumbing & Sanitary Design Calculator</title>

<!-- jsPDF and autotable for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<!-- SheetJS for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#2563eb;
  --primary-dark:#1d4ed8;
  --secondary:#64748b;
  --light:#f8fafc;
  --dark:#0f172a;
  --success:#10b981;
  --warning:#f59e0b;
  --danger:#ef4444;
  --border:#cbd5c1;
}
body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:#f1f5f9;color:var(--dark);padding:20px}
.container{max-width:1200px;margin:0 auto}
header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:20px;border-radius:10px;margin-bottom:20px}
h1{font-size:1.8rem;margin:0}
.subtitle{opacity:.9;margin-top:6px}
.disclaimer{background:#fff3cd;border:1px solid #ffeaa7;padding:10px;border-radius:6px;margin-top:10px;color:#000}
.tabs{display:flex;border-bottom:1px solid var(--border);gap:6px;flex-wrap:wrap;margin-bottom:12px}
.tab{padding:8px 14px;cursor:pointer;border-bottom:3px solid transparent}
.tab.active{border-bottom:3px solid var(--primary);font-weight:600;color:var(--primary)}
.tab-content{display:none}
.tab-content.active{display:block}
.section{background:#fff;padding:18px;border-radius:8px;border:1px solid var(--border);margin-bottom:18px}
.form-row{display:flex;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
.form-row label{flex:0 0 190px;font-weight:600;text-align:right}
.input-group{flex:1;display:flex;gap:8px;align-items:center}
.input-group input,.input-group select{flex:1;padding:8px;border-radius:6px;border:1px solid var(--border);min-width:0}
.unit{flex:0 0 70px;font-weight:600}
.button-group{display:flex;gap:10px;margin-top:10px}
button{padding:10px 14px;border-radius:6px;border:none;background:var(--primary);color:#fff;cursor:pointer;transition:all 0.2s ease}
button:hover{background:var(--primary-dark);transform:translateY(-1px)}
button:disabled{background:var(--secondary);cursor:not-allowed;transform:none}
button.secondary{background:var(--secondary)}
button.secondary:hover{background:#475569}
.output{margin-top:12px;padding:12px;border-radius:6px;background:#f8fafe;border-left:4px solid var(--primary);display:none}
.reference-table{width:100%;border-collapse:collapse;margin-top:10px}
.reference-table th,.reference-table td{padding:8px;border:1px solid #ddd}
.formula{font-family:monospace;background:#f8fafc;padding:8px;border-radius:6px;border-left:3px solid var(--primary)}
.grey-header{background:#e0e0e0;font-weight:bold}
.hidden-file{display:none}
.error{border-color:var(--danger) !important;background-color:#fef2f2}
.tooltip{position:relative;display:inline-block;border-bottom:1px dotted var(--secondary);cursor:help}
.tooltip .tooltiptext{visibility:hidden;width:200px;background-color:var(--dark);color:#fff;text-align:center;border-radius:6px;padding:5px;position:absolute;z-index:1;bottom:125%;left:50%;margin-left:-100px;opacity:0;transition:opacity 0.3s}
.tooltip:hover .tooltiptext{visibility:visible;opacity:1}

/* Design Calculator Specific Styles */
.calculator-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-bottom:16px}
.calc-section{margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #eee}
.calc-section:last-child{border-bottom:none}
.code-reference{font-size:0.85em;color:var(--secondary);font-style:italic;margin-top:5px}
.code-active{background:#e7f3ff;border-left:4px solid var(--primary);padding:10px;margin:10px 0}

/* Loading state */
.loading{opacity:0.7;position:relative;pointer-events:none}
.loading::after{content:'';position:absolute;top:50%;left:50%;width:20px;height:20px;margin:-10px 0 0 -10px;border:2px solid #f3f3f3;border-top:2px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

/* Success state */
.success{border-color:var(--success) !important;background-color:#f0fdf4}

/* Notification */
.notification{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:6px;color:white;z-index:1000;box-shadow:0 4px 6px rgba(0,0,0,0.1);transform:translateX(150%);transition:transform 0.3s ease}
.notification.show{transform:translateX(0)}
.notification.success{background:var(--success)}
.notification.error{background:var(--danger)}
.notification.warning{background:var(--warning)}

/* Design Summary Styles */
.summary-section{margin-bottom:25px;padding:15px;border:1px solid var(--border);border-radius:8px;background:#f8fafc}
.summary-section h5{margin-top:0;margin-bottom:15px;padding-bottom:8px;border-bottom:2px solid var(--primary);color:var(--primary-dark)}
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px}
.summary-item{background:white;padding:12px;border-radius:6px;border-left:3px solid var(--primary);box-shadow:0 2px 4px rgba(0,0,0,0.05)}
.summary-item p{margin:8px 0;font-size:0.9em}
.summary-item strong{color:var(--dark)}
.summary-category{font-weight:600;color:var(--primary-dark);margin-bottom:10px;font-size:1.1em}
.empty-summary{text-align:center;padding:30px;color:var(--secondary);font-style:italic}

/* System Identification Styles */
.system-header{background:linear-gradient(135deg, #e3f2fd, #bbdefb);padding:12px;border-radius:6px;margin-bottom:15px;border-left:4px solid var(--primary)}
.system-type{font-weight:600;color:var(--primary-dark);font-size:1.1em}
.system-application{color:var(--secondary);font-size:0.9em;margin-top:4px}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Plumbing & Sanitary Design Calculator</h1>
    <div class="subtitle">Professional design tools for plumbing engineers ‚Äî pipe sizing, pump selection, and system design</div>
    <div class="disclaimer">
      <strong>Note:</strong> These are enhanced engineering tools for professional preliminary design and analysis. For construction/permit use, validate with local codes and a licensed engineer.
    </div>
  </header>

  <div class="tabs" role="tablist">
    <div class="tab active" data-tab="project" role="tab" aria-selected="true" aria-controls="project" tabindex="0">Project Info</div>
    <div class="tab" data-tab="water-design" role="tab" aria-selected="false" aria-controls="water-design" tabindex="0">Water System Design</div>
    <div class="tab" data-tab="drainage" role="tab" aria-selected="false" aria-controls="drainage" tabindex="0">Drainage & Sanitary</div>
    <div class="tab" data-tab="pumps" role="tab" aria-selected="false" aria-controls="pumps" tabindex="0">Pump Systems</div>
    <div class="tab" data-tab="special-systems" role="tab" aria-selected="false" aria-controls="special-systems" tabindex="0">Special Systems & Reference</div>
  </div>

  <!-- Project Info -->
  <div id="project" class="tab-content active" role="tabpanel" aria-labelledby="project-tab">
    <div class="section">
      <h2>Project Information</h2>
      <div class="form-row">
        <label for="projectName">Project Name:</label>
        <div class="input-group"><input id="projectName" type="text" value="Commercial Building Plumbing Design" aria-required="true"></div>
      </div>
      <div class="form-row">
        <label for="clientName">Client Name:</label>
        <div class="input-group"><input id="clientName" type="text" value="ABC Development Corporation" aria-required="true"></div>
      </div>
      <div class="form-row">
        <label for="projectLocation">Location:</label>
        <div class="input-group"><input id="projectLocation" type="text" value="Manila, Philippines" aria-required="true"></div>
      </div>
      <div class="form-row">
        <label for="preparedBy">Prepared By:</label>
        <div class="input-group"><input id="preparedBy" type="text" value="Juan Dela Cruz, Plumbing Engineer" aria-required="true"></div>
      </div>
      
      <div class="form-row">
        <label for="codeStandard">Plumbing Code Standard:</label>
        <div class="input-group">
          <select id="codeStandard" aria-label="Select plumbing code standard">
            <option value="rnpcp">RNPCP 2021 (Philippines)</option>
            <option value="ipc">IPC 2024 (International)</option>
            <option value="upc">UPC 2024 (Uniform)</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <label for="units">Measurement Units:</label>
        <div class="input-group">
          <select id="units" aria-label="Select measurement units">
            <option value="metric">Metric (m, L/s)</option>
            <option value="imperial">Imperial (ft, gpm)</option>
          </select>
        </div>
      </div>

      <div class="button-group">
        <button id="saveProjectBtn">Save Project (JSON)</button>
        <button class="secondary" id="loadProjectBtn">Load Project (JSON)</button>
        <input id="jsonFileInput" type="file" accept=".json,application/json" class="hidden-file" aria-label="Load project from JSON file">
        <button class="secondary" id="resetBtn" style="background-color:var(--danger)">Reset</button>
      </div>

      <!-- Active Code Standard Display -->
      <div id="activeCodeDisplay" class="code-active">
        <strong>Active Design Standard:</strong> RNPCP 2021 (Philippines)
      </div>
    </div>
  </div>

  <!-- Water System Design -->
  <div id="water-design" class="tab-content" role="tabpanel" aria-labelledby="water-design-tab">
    <div class="section">
      <h2>Water System Design Tools</h2>
      
      <!-- Code-specific header -->
      <div id="waterCodeHeader" class="code-active">
        <strong>Designing per:</strong> RNPCP 2021 (Philippines) - Water Supply Systems
      </div>
      
      <div class="calculator-grid">
        <!-- Water Supply & Pipe Sizing -->
        <div class="calc-section">
          <h3>Water Supply & Pipe Sizing</h3>
          <p class="code-reference" id="waterSupplyReference">Reference: RNPCP 2021 Section 611 | Velocity: 1.5-2.5 m/s</p>
          
          <div class="form-row">
            <label for="waterFixtureUnits">Total Fixture Units:</label>
            <div class="input-group">
              <input id="waterFixtureUnits" type="number" min="0" value="50" aria-label="Total fixture units">
            </div>
          </div>
          
          <div class="form-row">
            <label for="waterPeakFactor">Peak Factor:</label>
            <div class="input-group">
              <input id="waterPeakFactor" type="number" step="0.1" min="0.5" max="1.0" value="0.7" aria-label="Peak factor between 0.5 and 1.0">
              <div class="unit" id="peakFactorNote">(0.5-1.0)</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="waterSupplyPressure">Supply Pressure:</label>
            <div class="input-group">
              <input id="waterSupplyPressure" type="number" min="0" value="30" aria-label="Supply pressure">
              <div class="unit" id="pressureUnit">m</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="waterMinPressure">Min Fixture Pressure:</label>
            <div class="input-group">
              <input id="waterMinPressure" type="number" min="0" value="10" aria-label="Minimum fixture pressure">
              <div class="unit" id="minPressureUnit">m</div>
            </div>
          </div>
          
          <button id="waterSupplyBtn">Calculate Flow & Pipe Size</button>
          <div id="waterSupplyOutput" class="output"></div>
        </div>

        <!-- Water Tank & Reservoir Sizing -->
        <div class="calc-section">
          <h3>Water Tank & Reservoir Sizing</h3>
          <p class="code-reference" id="tankReference">Reference: RNPCP 2021 Section 603</p>
          
          <div class="form-row">
            <label for="tankPopulation">Population Served:</label>
            <div class="input-group">
              <input id="tankPopulation" type="number" min="0" value="100" aria-label="Population served">
              <div class="unit">people</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="tankDailyDemand">Daily Demand:</label>
            <div class="input-group">
              <input id="tankDailyDemand" type="number" min="0" value="180" aria-label="Daily water demand">
              <div class="unit" id="demandUnit">L/day</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="tankEmergencyDays">Emergency Days:</label>
            <div class="input-group">
              <input id="tankEmergencyDays" type="number" min="0" value="2" aria-label="Emergency supply days">
              <div class="unit">days</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="tankFireReserve">Fire Reserve:</label>
            <div class="input-group">
              <input id="tankFireReserve" type="number" min="0" value="18000" aria-label="Fire reserve volume">
              <div class="unit" id="fireReserveUnit">L</div>
            </div>
          </div>
          
          <button id="tankSizeBtn">Calculate Tank Size</button>
          <div id="tankSizeOutput" class="output"></div>
        </div>

        <!-- Booster Pump Sizing -->
        <div class="calc-section">
          <h3>Domestic Water Booster Pump</h3>
          <p class="code-reference" id="boosterPumpReference">Reference: RNPCP 2021 Section 612 | Basic sizing for domestic water systems</p>
          
          <div class="form-row">
            <label for="pumpFlow">Required Flow:</label>
            <div class="input-group">
              <input id="pumpFlow" type="number" min="0" value="5" aria-label="Required pump flow">
              <div class="unit" id="pumpFlowUnit">L/s</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="pumpElevation">Elevation Difference:</label>
            <div class="input-group">
              <input id="pumpElevation" type="number" value="15" aria-label="Elevation difference">
              <div class="unit" id="elevationUnit">m</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="pumpFriction">Friction Loss:</label>
            <div class="input-group">
              <input id="pumpFriction" type="number" min="0" value="8" aria-label="Friction loss">
              <div class="unit" id="frictionUnit">m</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="pumpSafety">Safety Margin:</label>
            <div class="input-group">
              <input id="pumpSafety" type="number" min="0" max="100" value="15" aria-label="Safety margin percentage">
              <div class="unit">%</div>
            </div>
          </div>
          
          <button id="boosterPumpBtn">Calculate Pump TDH</button>
          <div id="boosterPumpOutput" class="output"></div>
        </div>

        <!-- Hot Water System Demand -->
        <div class="calc-section">
          <h3>Hot Water System Demand</h3>
          <p class="code-reference" id="hotWaterReference">Reference: RNPCP 2021 Section 607</p>
          
          <div class="form-row">
            <label for="hotWaterBathrooms">Number of Bathrooms:</label>
            <div class="input-group">
              <input id="hotWaterBathrooms" type="number" min="0" value="10" aria-label="Number of bathrooms">
            </div>
          </div>
          
          <div class="form-row">
            <label for="hotWaterSimultaneous">Simultaneous Use:</label>
            <div class="input-group">
              <input id="hotWaterSimultaneous" type="number" min="0" max="100" value="15" aria-label="Simultaneous use percentage">
              <div class="unit">%</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="hotWaterFraction">Hot Fraction:</label>
            <div class="input-group">
              <input id="hotWaterFraction" type="number" step="0.01" min="0" max="1" value="0.6" aria-label="Hot water fraction">
            </div>
          </div>
          
          <button id="hotWaterBtn">Calculate Peak Hot Flow</button>
          <div id="hotWaterOutput" class="output"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Drainage & Sanitary -->
  <div id="drainage" class="tab-content" role="tabpanel" aria-labelledby="drainage-tab">
    <div class="section">
      <h2>Drainage & Sanitary System Design</h2>
      
      <!-- Code-specific header -->
      <div id="drainageCodeHeader" class="code-active">
        <strong>Designing per:</strong> RNPCP 2021 (Philippines) - Drainage Systems
      </div>
      
      <div class="calculator-grid">
        <!-- Sanitary Sewer Load -->
        <div class="calc-section">
          <h3>Sanitary Sewer Load Calculation</h3>
          <p class="code-reference" id="sewerReference">Reference: RNPCP 2021 Section 701</p>
          
          <div class="form-row">
            <label for="sewerDFU">Total DFU:</label>
            <div class="input-group">
              <input id="sewerDFU" type="number" min="0" value="85" aria-label="Total drainage fixture units">
            </div>
          </div>
          
          <div class="form-row">
            <label for="sewerSlope">Pipe Slope:</label>
            <div class="input-group">
              <select id="sewerSlope" aria-label="Select pipe slope">
                <option value="0.02">2% (DN 50-100)</option>
                <option value="0.015">1.5% (DN 125)</option>
                <option value="0.01">1% (DN 150+)</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <label for="sewerFixtureType">Fixture Type:</label>
            <div class="input-group">
              <select id="sewerFixtureType" aria-label="Select fixture type">
                <option value="residential">Residential</option>
                <option value="commercial">Commercial</option>
                <option value="institutional">Institutional</option>
              </select>
            </div>
          </div>
          
          <button id="sewerBtn">Calculate Drainage Size</button>
          <div id="sewerOutput" class="output"></div>
        </div>

        <!-- Storm Drainage -->
        <div class="calc-section">
          <h3>Storm Drainage ‚Äî Rational Method</h3>
          <p class="code-reference" id="stormReference">Reference: RNPCP 2021 Section 1102</p>
          
          <div class="form-row">
            <label for="stormArea">Roof Area:</label>
            <div class="input-group">
              <input id="stormArea" type="number" min="0" value="500" aria-label="Roof area">
              <div class="unit" id="areaUnit">m¬≤</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="stormIntensity">Rain Intensity:</label>
            <div class="input-group">
              <input id="stormIntensity" type="number" min="0" value="120" aria-label="Rain intensity">
              <div class="unit" id="intensityUnit">mm/hr</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="stormCoefficient">Runoff Coefficient:</label>
            <div class="input-group">
              <select id="stormCoefficient" aria-label="Select runoff coefficient">
                <option value="0.9">0.9 (Steep roof)</option>
                <option value="0.8" selected>0.8 (Typical roof)</option>
                <option value="0.7">0.7 (Flat roof)</option>
                <option value="0.6">0.6 (Green roof)</option>
              </select>
            </div>
          </div>
          
          <button id="stormBtn">Calculate Storm Flow</button>
          <div id="stormOutput" class="output"></div>
        </div>

        <!-- Septic Tank Sizing -->
        <div class="calc-section">
          <h3>Septic Tank Sizing</h3>
          <p class="code-reference" id="septicReference">Reference: RNPCP 2021 & DOH Standards</p>
          
          <div class="form-row">
            <label for="septicPersons">Number of Persons:</label>
            <div class="input-group">
              <input id="septicPersons" type="number" min="0" value="10" aria-label="Number of persons">
              <div class="unit">people</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="septicFlowPerPerson">Daily Flow per Person:</label>
            <div class="input-group">
              <input id="septicFlowPerPerson" type="number" min="0" value="150" aria-label="Daily flow per person">
              <div class="unit" id="septicFlowUnit">L/day</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="septicRetention">Retention Time:</label>
            <div class="input-group">
              <input id="septicRetention" type="number" min="0" value="36" aria-label="Retention time">
              <div class="unit">hours</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="septicCompartments">Compartments:</label>
            <div class="input-group">
              <select id="septicCompartments" aria-label="Select number of compartments">
                <option value="1">Single compartment</option>
                <option value="2" selected>Two compartments</option>
                <option value="3">Three compartments</option>
              </select>
            </div>
          </div>
          
          <button id="septicBtn">Calculate Septic Volume</button>
          <div id="septicOutput" class="output"></div>
        </div>

        <!-- Grease Trap Sizing -->
        <div class="calc-section">
          <h3>Grease Trap Sizing</h3>
          <p class="code-reference" id="greaseReference">Reference: RNPCP 2021 Section 1011</p>
          
          <div class="form-row">
            <label for="greaseFixtureType">Fixture Type:</label>
            <div class="input-group">
              <select id="greaseFixtureType" aria-label="Select grease trap fixture type">
                <option value="sink">Kitchen Sink</option>
                <option value="dishwasher">Commercial Dishwasher</option>
                <option value="floor">Floor Drain</option>
                <option value="multiple">Multiple Fixtures</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <label for="greaseFlow">Flow Rate:</label>
            <div class="input-group">
              <input id="greaseFlow" type="number" min="0" value="2" aria-label="Grease trap flow rate">
              <div class="unit" id="greaseFlowUnit">L/s</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="greaseRetention">Retention Time:</label>
            <div class="input-group">
              <input id="greaseRetention" type="number" min="0" value="25" aria-label="Retention time">
              <div class="unit">minutes</div>
            </div>
          </div>
          
          <button id="greaseBtn">Calculate Grease Volume</button>
          <div id="greaseOutput" class="output"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pump Systems -->
  <div id="pumps" class="tab-content" role="tabpanel" aria-labelledby="pumps-tab">
    <div class="section">
      <h2>Pump System Design</h2>
      
      <!-- Code-specific header -->
      <div id="pumpCodeHeader" class="code-active">
        <strong>Designing per:</strong> RNPCP 2021 (Philippines) - Pump Systems
      </div>
      
      <div class="calculator-grid">
        <!-- Booster Pump Power Calculation -->
        <div class="calc-section">
          <h3>Booster Pump Power Calculation</h3>
          <p class="code-reference" id="boosterReference">Reference: RNPCP 2021 Section 612 | Detailed power analysis for pump specification</p>
          
          <div class="form-row">
            <label for="boosterFlow">Required Flow:</label>
            <div class="input-group">
              <input id="boosterFlow" type="number" min="0" value="8" aria-label="Required booster pump flow">
              <div class="unit" id="boosterFlowUnit">L/s</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="boosterLift">Static Lift:</label>
            <div class="input-group">
              <input id="boosterLift" type="number" value="12" aria-label="Static lift">
              <div class="unit" id="boosterLiftUnit">m</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="boosterFriction">Friction Loss:</label>
            <div class="input-group">
              <input id="boosterFriction" type="number" min="0" value="5" aria-label="Friction loss">
              <div class="unit" id="boosterFrictionUnit">m</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="boosterEfficiency">Efficiency:</label>
            <div class="input-group">
              <input id="boosterEfficiency" type="number" min="0" max="100" value="75" aria-label="Pump efficiency">
              <div class="unit">%</div>
            </div>
          </div>
          
          <button id="boosterBtn2">Calculate Pump Power</button>
          <div id="boosterOutput" class="output"></div>
        </div>

        <!-- Sump Pump & Lift Station -->
        <div class="calc-section">
          <h3>Sump Pump & Lift Station</h3>
          <p class="code-reference" id="sumpReference">Reference: RNPCP 2021 Section 1201</p>
          
          <div class="form-row">
            <label for="sumpVolume">Sump Volume:</label>
            <div class="input-group">
              <input id="sumpVolume" type="number" min="0" value="2000" aria-label="Sump volume">
              <div class="unit" id="sumpVolumeUnit">L</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="sumpTime">Emptying Time:</label>
            <div class="input-group">
              <input id="sumpTime" type="number" min="0" value="10" aria-label="Emptying time">
              <div class="unit">minutes</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="sumpHead">Static Head:</label>
            <div class="input-group">
              <input id="sumpHead" type="number" value="8" aria-label="Static head">
              <div class="unit" id="sumpHeadUnit">m</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="sumpApplication">Application:</label>
            <div class="input-group">
              <select id="sumpApplication" aria-label="Select sump pump application">
                <option value="residential">Residential</option>
                <option value="commercial">Commercial</option>
                <option value="stormwater">Stormwater</option>
                <option value="sewage">Sewage</option>
              </select>
            </div>
          </div>
          
          <button id="sumpBtn">Calculate Pump Q & Power</button>
          <div id="sumpOutput" class="output"></div>
        </div>

        <!-- Fire Protection Pump -->
        <div class="calc-section">
          <h3>Fire Protection Pump Sizing</h3>
          <p class="code-reference" id="firePumpReference">Reference: NFPA 14 (2023) & BFP Standards</p>
          
          <div class="form-row">
            <label for="firePumpFlow">Required Flow:</label>
            <div class="input-group">
              <input id="firePumpFlow" type="number" min="0" value="32" aria-label="Fire pump flow">
              <div class="unit" id="fireFlowUnit">L/s</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="firePumpTDH">Total Dynamic Head:</label>
            <div class="input-group">
              <input id="firePumpTDH" type="number" min="0" value="45" aria-label="Total dynamic head">
              <div class="unit" id="fireHeadUnit">m</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="firePumpEfficiency">Pump Efficiency:</label>
            <div class="input-group">
              <input id="firePumpEfficiency" type="number" min="0" max="100" value="70" aria-label="Fire pump efficiency">
              <div class="unit">%</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="fireBuildingType">Building Type:</label>
            <div class="input-group">
              <select id="fireBuildingType" aria-label="Select building type">
                <option value="residential">Residential</option>
                <option value="commercial">Commercial</option>
                <option value="business">Business</option>
                <option value="industrial">Industrial</option>
              </select>
            </div>
          </div>
          
          <button id="firePumpBtn">Calculate Pump Power</button>
          <div id="firePumpOutput" class="output"></div>
        </div>

        <!-- Rainwater Pump Sizing -->
        <div class="calc-section">
          <h3>Rainwater Pump Sizing</h3>
          <p class="code-reference" id="rainPumpReference">Reference: PGBC 2015 Requirements</p>
          
          <div class="form-row">
            <label for="rainPumpFlow">Required Flow:</label>
            <div class="input-group">
              <input id="rainPumpFlow" type="number" min="0" value="3" aria-label="Rainwater pump flow">
              <div class="unit" id="rainFlowUnit">L/s</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="rainPumpTDH">Total Dynamic Head:</label>
            <div class="input-group">
              <input id="rainPumpTDH" type="number" min="0" value="25" aria-label="Total dynamic head">
              <div class="unit" id="rainHeadUnit">m</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="rainPumpEfficiency">Pump Efficiency:</label>
            <div class="input-group">
              <input id="rainPumpEfficiency" type="number" min="0" max="100" value="70" aria-label="Rainwater pump efficiency">
              <div class="unit">%</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="rainUsageType">Usage Type:</label>
            <div class="input-group">
              <select id="rainUsageType" aria-label="Select rainwater usage type">
                <option value="irrigation">Irrigation</option>
                <option value="toilet">Toilet Flushing</option>
                <option value="laundry">Laundry</option>
                <option value="general">General Use</option>
              </select>
            </div>
          </div>
          
          <button id="rainPumpBtn">Calculate Pump Power</button>
          <div id="rainwaterPumpOutput" class="output"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Special Systems & Reference -->
  <div id="special-systems" class="tab-content" role="tabpanel" aria-labelledby="special-systems-tab">
    <div class="section">
      <h2>Special Systems & Code References</h2>
      
      <!-- Code-specific header -->
      <div id="specialCodeHeader" class="code-active">
        <strong>Designing per:</strong> RNPCP 2021 (Philippines) - Special Systems
      </div>
      
      <div class="calculator-grid">
        <!-- Fire Protection / Standpipe -->
        <div class="calc-section">
          <h3>Fire Protection ‚Äî Standpipe</h3>
          <p class="code-reference" id="fireReference">Reference: NFPA 14 (2023) & BFP Standards</p>
          
          <div class="form-row">
            <label for="standpipeCount">Number of Standpipes:</label>
            <div class="input-group">
              <input id="standpipeCount" type="number" min="0" value="2" aria-label="Number of standpipes">
            </div>
          </div>
          
          <div class="form-row">
            <label for="standpipeFlow">Flow per Standpipe:</label>
            <div class="input-group">
              <input id="standpipeFlow" type="number" min="0" value="32" aria-label="Flow per standpipe">
              <div class="unit" id="standpipeFlowUnit">L/s</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="standpipeDuration">Duration:</label>
            <div class="input-group">
              <input id="standpipeDuration" type="number" min="0" value="60" aria-label="Fire duration">
              <div class="unit">minutes</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="buildingHeight">Building Height:</label>
            <div class="input-group">
              <select id="buildingHeight" aria-label="Select building height">
                <option value="low">Low-rise (< 23m)</option>
                <option value="medium">Medium-rise (23-50m)</option>
                <option value="high">High-rise (> 50m)</option>
              </select>
            </div>
          </div>
          
          <button id="fireDemandBtn">Calculate Fire Demand</button>
          <div id="fireDemandOutput" class="output"></div>
        </div>

        <!-- Rainwater Tank Sizing -->
        <div class="calc-section">
          <h3>Rainwater Tank Sizing</h3>
          <p class="code-reference" id="rainTankReference">Reference: PGBC 2015 Requirements</p>
          
          <div class="form-row">
            <label for="rainRoofArea">Roof Area:</label>
            <div class="input-group">
              <input id="rainRoofArea" type="number" min="0" value="300" aria-label="Roof area for rainwater collection">
              <div class="unit" id="rainAreaUnit">m¬≤</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="rainRainfall">Annual Rainfall:</label>
            <div class="input-group">
              <input id="rainRainfall" type="number" min="0" value="2000" aria-label="Annual rainfall">
              <div class="unit" id="rainfallUnit">mm/yr</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="rainEfficiency">Collection Efficiency:</label>
            <div class="input-group">
              <input id="rainEfficiency" type="number" min="0" max="100" value="85" aria-label="Collection efficiency">
              <div class="unit">%</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="rainDemand">Daily Water Demand:</label>
            <div class="input-group">
              <input id="rainDemand" type="number" min="0" value="5000" aria-label="Daily water demand">
              <div class="unit" id="rainDemandUnit">L/day</div>
            </div>
          </div>
          
          <button id="rainTankBtn">Calculate Tank Size</button>
          <div id="rainwaterTankOutput" class="output"></div>
        </div>

        <!-- STP Design -->
        <div class="calc-section">
          <h3>Sewage Treatment Plant (STP) Design</h3>
          <p class="code-reference" id="stpReference">Reference: DENR DAO 2016-08</p>
          
          <div class="form-row">
            <label for="stpFlow">Daily Wastewater Flow:</label>
            <div class="input-group">
              <input id="stpFlow" type="number" min="0" value="50" aria-label="Daily wastewater flow">
              <div class="unit" id="stpFlowUnit">m¬≥/day</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="stpBOD">BOD5 Influent:</label>
            <div class="input-group">
              <input id="stpBOD" type="number" min="0" value="250" aria-label="BOD5 influent concentration">
              <div class="unit">mg/L</div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="stpTreatment">Treatment Type:</label>
            <div class="input-group">
              <select id="stpTreatment" aria-label="Select treatment type">
                <option value="mbbr">MBBR (Moving Bed Biofilm Reactor)</option>
                <option value="mbr">MBR (Membrane Bioreactor)</option>
                <option value="sbr">SBR (Sequencing Batch Reactor)</option>
                <option value="activated">Activated Sludge</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <label for="stpEffluent">Effluent Quality:</label>
            <div class="input-group">
              <select id="stpEffluent" aria-label="Select effluent quality">
                <option value="class_c">Class C (DENR Standards)</option>
                <option value="class_b">Class B (Higher Quality)</option>
                <option value="reuse">Reuse Quality</option>
              </select>
            </div>
          </div>
          
          <button id="stpBtn">Calculate STP Volume</button>
          <div id="stpVolumeOutput" class="output"></div>
        </div>

        <!-- DFU Tables -->
        <div class="calc-section">
          <h3>Drainage Fixture Unit (DFU) Tables</h3>
          <p class="code-reference" id="dfuReference">Reference: RNPCP 2021 Table 7-3</p>
          
          <div class="form-row" style="margin-top: 15px;">
            <label for="dfuCodeSelect">Select Code Standard:</label>
            <div class="input-group">
              <select id="dfuCodeSelect" aria-label="Select DFU code standard">
                <option value="rnpcp">RNPCP 2021</option>
                <option value="ipc">IPC 2024</option>
                <option value="upc">UPC 2024</option>
              </select>
            </div>
          </div>
          <div id="dfuTableOutput" class="output"></div>
        </div>
      </div>
      
      <div class="button-group" style="margin-top: 20px;">
        <button id="summaryBtn">Generate Design Summary</button>
        <button class="secondary" id="pdfBtn">Export to PDF</button>
        <button class="secondary" id="excelBtn">Export to Excel</button>
      </div>
      
      <div id="designSummaryOutput" class="output"></div>
    </div>
  </div>

</div>

<!-- Notification Container -->
<div id="notification" class="notification"></div>

<script>
// Global state
let designResults = {};
let currentCodeStandard = 'rnpcp'; // Default to RNPCP
let currentUnits = 'metric'; // Default to metric

// DOM element cache for performance
const domCache = {};

// Get DOM element with caching
function getElement(id) {
    if (!domCache[id]) {
        domCache[id] = document.getElementById(id);
    }
    return domCache[id];
}

// Notification system
function showNotification(message, type = 'success') {
    const notification = getElement('notification');
    notification.textContent = message;
    notification.className = `notification ${type} show`;
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 4000);
}

// Code Standard Database
const CODE_STANDARDS = {
    rnpcp: {
        name: "RNPCP 2021 (Philippines)",
        waterSupply: "RNPCP 2021 Section 611",
        drainage: "RNPCP 2021 Section 701", 
        pumps: "RNPCP 2021 Section 612",
        special: "RNPCP 2021 & BFP Standards",
        velocity: "1.5-2.5 m/s",
        minPressure: "10 m at fixtures",
        pressureUnit: "m",
        flowUnit: "L/s",
        demandUnit: "L/day",
        fireReserveUnit: "L",
        areaUnit: "m¬≤",
        notes: "Includes BFP fire protection requirements"
    },
    ipc: {
        name: "IPC 2024 (International)",
        waterSupply: "IPC 2024 Chapter 6",
        drainage: "IPC 2024 Chapter 7",
        pumps: "IPC 2024 Section 604.3",
        special: "IPC 2024 & NFPA Standards",
        velocity: "0.6-2.4 m/s", 
        minPressure: "15 psi at fixtures",
        pressureUnit: "psi",
        flowUnit: "gpm",
        demandUnit: "gal/day",
        fireReserveUnit: "gal",
        areaUnit: "ft¬≤",
        notes: "International Plumbing Code 2024"
    },
    upc: {
        name: "UPC 2024 (Uniform)",
        waterSupply: "UPC 2024 Chapter 6",
        drainage: "UPC 2024 Chapter 7", 
        pumps: "UPC 2024 Section 604.3",
        special: "UPC 2024 & NFPA Standards",
        velocity: "0.6-2.4 m/s",
        minPressure: "15 psi at fixtures",
        pressureUnit: "psi",
        flowUnit: "gpm", 
        demandUnit: "gal/day",
        fireReserveUnit: "gal",
        areaUnit: "ft¬≤",
        notes: "Uniform Plumbing Code 2024"
    }
};

// DFU Tables for different codes
const DFU_TABLES = {
    rnpcp: [
        { fixture: "Water closet (tank)", private: 4, public: 6, minPipe: "25 mm" },
        { fixture: "Water closet (valve)", private: 6, public: 8, minPipe: "32 mm" },
        { fixture: "Lavatory", private: 1, public: 1, minPipe: "15 mm" },
        { fixture: "Bathtub", private: 2, public: 2, minPipe: "20 mm" },
        { fixture: "Shower head", private: 2, public: 2, minPipe: "20 mm" },
        { fixture: "Kitchen sink", private: 2, public: 2, minPipe: "20 mm" },
        { fixture: "Urinal (tank)", private: 4, public: 6, minPipe: "25 mm" },
        { fixture: "Floor drain", private: 2, public: 2, minPipe: "50 mm" }
    ],
    ipc: [
        { fixture: "Water closet (tank)", private: 4, public: 6, minPipe: "1 in" },
        { fixture: "Water closet (valve)", private: 6, public: 8, minPipe: "1.25 in" },
        { fixture: "Lavatory", private: 1, public: 1, minPipe: "0.5 in" },
        { fixture: "Bathtub", private: 2, public: 2, minPipe: "0.75 in" },
        { fixture: "Shower head", private: 2, public: 2, minPipe: "0.75 in" },
        { fixture: "Kitchen sink", private: 2, public: 2, minPipe: "0.75 in" },
        { fixture: "Urinal (tank)", private: 4, public: 6, minPipe: "1 in" },
        { fixture: "Floor drain", private: 2, public: 2, minPipe: "2 in" }
    ],
    upc: [
        { fixture: "Water closet (tank)", private: 4, public: 6, minPipe: "1 in" },
        { fixture: "Water closet (valve)", private: 6, public: 8, minPipe: "1.25 in" },
        { fixture: "Lavatory", private: 1, public: 1, minPipe: "0.5 in" },
        { fixture: "Bathtub", private: 2, public: 2, minPipe: "0.75 in" },
        { fixture: "Shower head", private: 2, public: 2, minPipe: "0.75 in" },
        { fixture: "Kitchen sink", private: 2, public: 2, minPipe: "0.75 in" },
        { fixture: "Urinal (tank)", private: 4, public: 6, minPipe: "1 in" },
        { fixture: "Floor drain", private: 2, public: 2, minPipe: "2 in" }
    ]
};

// System Identification Database - UPDATED WITH YOUR APPROACH
const SYSTEM_IDENTIFICATIONS = {
    waterSupply: {
        title: "üö∞ DOMESTIC WATER SUPPLY SYSTEM",
        type: "Domestic Cold Water Distribution", 
        application: "Building potable water supply",
        icon: "üö∞"
    },
    tankSize: {
        title: "üíß WATER STORAGE SYSTEM",
        type: "Domestic Water Storage Tank",
        application: "Potable water storage & fire reserve",
        icon: "üíß"
    },
    // UPDATED: Water System Tab Booster Pump - Basic Sizing
    boosterPump: {
        title: "‚ö° DOMESTIC WATER BOOSTER PUMP",
        type: "Domestic Water Booster Pump",
        application: "Basic sizing for domestic water pressure boosting",
        icon: "‚ö°"
    },
    hotWater: {
        title: "üî• HOT WATER SYSTEM",
        type: "Domestic Hot Water Circulation",
        application: "Hot water distribution",
        icon: "üî•"
    },
    sewer: {
        title: "üöΩ SANITARY DRAINAGE SYSTEM",
        type: "Sanitary Sewer & Wastewater",
        application: "Building wastewater drainage",
        icon: "üöΩ"
    },
    storm: {
        title: "üåßÔ∏è STORM DRAINAGE SYSTEM",
        type: "Stormwater Drainage",
        application: "Roof & surface water drainage", 
        icon: "üåßÔ∏è"
    },
    septic: {
        title: "üõ¢Ô∏è SEPTIC SYSTEM",
        type: "Septic Tank & Treatment",
        application: "On-site wastewater treatment",
        icon: "üõ¢Ô∏è"
    },
    greaseTrap: {
        title: "üõ¢Ô∏è GREASE INTERCEPTOR SYSTEM",
        type: "Grease Trap & Interceptor",
        application: "Kitchen wastewater pretreatment",
        icon: "üõ¢Ô∏è"
    },
    // UPDATED: Pump Systems Tab Booster Pump - Detailed Power Analysis
    boosterPump2: {
        title: "‚ö° BOOSTER PUMP POWER CALCULATION",
        type: "Booster Pump Power Analysis",
        application: "Detailed power calculation for pump specification",
        icon: "‚ö°"
    },
    sumpPump: {
        title: "üí¶ SUMP PUMP SYSTEM",
        type: "Drainage Sump & Lift Station",
        application: "Basement/underground drainage",
        icon: "üí¶"
    },
    firePump: {
        title: "üöí FIRE PROTECTION PUMP SYSTEM",
        type: "Fire Pump & Standpipe",
        application: "Fire protection water supply",
        icon: "üöí"
    },
    rainwaterPump: {
        title: "üåßÔ∏è RAINWATER PUMP SYSTEM", 
        type: "Rainwater Harvesting Pump",
        application: "Rainwater collection & reuse",
        icon: "üåßÔ∏è"
    },
    fireDemand: {
        title: "üöí FIRE PROTECTION SYSTEM",
        type: "Standpipe & Fire Hydrant",
        application: "Fire fighting water demand",
        icon: "üöí"
    },
    rainwaterTank: {
        title: "üíß RAINWATER HARVESTING SYSTEM",
        type: "Rainwater Collection Tank",
        application: "Rainwater storage & reuse",
        icon: "üíß"
    },
    stpVolume: {
        title: "üè≠ SEWAGE TREATMENT SYSTEM",
        type: "Sewage Treatment Plant (STP)",
        application: "Wastewater treatment",
        icon: "üè≠"
    }
};

// Conversion factors
const CONVERSIONS = {
    m_to_ft: 3.28084,
    ft_to_m: 0.3048,
    l_to_gal: 0.264172,
    gal_to_l: 3.78541,
    lps_to_gpm: 15.8503,
    gpm_to_lps: 0.06309,
    m_to_psi: 1.422, // 1m head = 1.422 psi
    psi_to_m: 0.703, // 1 psi = 0.703m head
    mm_to_in: 0.0393701,
    in_to_mm: 25.4,
    m2_to_ft2: 10.7639,
    ft2_to_m2: 0.092903,
    mmhr_to_inhr: 0.0393701,
    inhr_to_mmhr: 25.4
};

// Enhanced input validation function
function validateInput(id, min, max, label) {
    const element = getElement(id);
    const value = safeNumber(element.value);
    
    if (value < min || value > max) {
        element.classList.add('error');
        showNotification(`${label} must be between ${min} and ${max}.`, 'error');
        return false;
    }
    
    element.classList.remove('error');
    return true;
}

// Validate all inputs in a form
function validateAllInputs(inputsConfig) {
    let isValid = true;
    
    inputsConfig.forEach(config => {
        if (!validateInput(config.id, config.min, config.max, config.label)) {
            isValid = false;
        }
    });
    
    return isValid;
}

// Sanitize input strings to prevent XSS
function sanitize(str) {
    if (typeof str !== 'string') return str;
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// Safe calculation wrapper with error handling
function safeCalculation(calculationFunction, buttonId) {
    return async function() {
        const button = getElement(buttonId);
        const originalText = button.textContent;
        
        try {
            // Show loading state
            button.classList.add('loading');
            button.disabled = true;
            
            // Execute calculation
            await calculationFunction();
            
            // Show success state briefly
            button.classList.remove('loading');
            button.classList.add('success');
            setTimeout(() => button.classList.remove('success'), 2000);
            
        } catch (error) {
            console.error('Calculation error:', error);
            showNotification(`Calculation failed: ${error.message}`, 'error');
            button.classList.remove('loading');
        } finally {
            button.disabled = false;
            button.textContent = originalText;
        }
    };
}

// Format system output with clear identification
function formatSystemOutput(systemKey, contentHTML) {
    const system = SYSTEM_IDENTIFICATIONS[systemKey] || {
        title: "SYSTEM RESULTS",
        type: "Engineering System",
        application: "Building services system",
        icon: "‚öôÔ∏è"
    };
    
    return `
        <h4>${system.icon} ${system.title}</h4>
        <div class="system-header">
            <div class="system-type">${system.type}</div>
            <div class="system-application">${system.application}</div>
        </div>
        ${contentHTML}
    `;
}

// Update units when selection changes
function updateUnits() {
    currentUnits = getElement('units').value;
    updateAllUnits();
}

// Update code standard when selection changes
function updateCodeStandard() {
    currentCodeStandard = getElement('codeStandard').value;
    const code = CODE_STANDARDS[currentCodeStandard];
    
    if (!code) return;
    
    // Update active code displays
    getElement('activeCodeDisplay').innerHTML = 
        `<strong>Active Design Standard:</strong> ${code.name}`;
    
    getElement('waterCodeHeader').innerHTML = 
        `<strong>Designing per:</strong> ${code.name} - Water Supply Systems`;
    
    getElement('drainageCodeHeader').innerHTML = 
        `<strong>Designing per:</strong> ${code.name} - Drainage Systems`;
    
    getElement('pumpCodeHeader').innerHTML = 
        `<strong>Designing per:</strong> ${code.name} - Pump Systems`;
    
    getElement('specialCodeHeader').innerHTML = 
        `<strong>Designing per:</strong> ${code.name} - Special Systems`;
    
    // Update all references and units throughout the calculator
    updateAllReferencesAndUnits();
}

// Update all references and units based on current code standard
function updateAllReferencesAndUnits() {
    const code = CODE_STANDARDS[currentCodeStandard];
    
    // Water System References
    getElement('waterSupplyReference').textContent = 
        `Reference: ${code.waterSupply} | Velocity: ${code.velocity}`;
    getElement('tankReference').textContent = 
        `Reference: ${code.waterSupply}`;
    getElement('boosterPumpReference').textContent = 
        `Reference: ${code.pumps} | Basic sizing for domestic water systems`;
    getElement('hotWaterReference').textContent = 
        `Reference: ${code.waterSupply}`;
    
    // Drainage System References
    getElement('sewerReference').textContent = 
        `Reference: ${code.drainage}`;
    getElement('stormReference').textContent = 
        `Reference: ${code.drainage}`;
    getElement('septicReference').textContent = 
        `Reference: ${code.drainage}`;
    getElement('greaseReference').textContent = 
        `Reference: ${code.drainage}`;
    
    // Pump System References
    getElement('boosterReference').textContent = 
        `Reference: ${code.pumps} | Detailed power analysis for pump specification`;
    getElement('sumpReference').textContent = 
        `Reference: ${code.pumps}`;
    getElement('firePumpReference').textContent = 
        `Reference: ${code.special}`;
    getElement('rainPumpReference').textContent = 
        `Reference: ${code.special}`;
    
    // Special Systems References
    getElement('fireReference').textContent = 
        `Reference: ${code.special}`;
    getElement('rainTankReference').textContent = 
        `Reference: ${code.special}`;
    getElement('stpReference').textContent = 
        `Reference: ${code.special}`;
    getElement('dfuReference').textContent = 
        `Reference: ${code.drainage}`;
    
    // Update all units
    updateAllUnits();
}

// Update all measurement units based on current code
function updateAllUnits() {
    const code = CODE_STANDARDS[currentCodeStandard];
    
    // Determine which units to use based on user selection
    const useMetric = currentUnits === 'metric';
    
    // Water System Units
    getElement('pressureUnit').textContent = useMetric ? 'm' : 'psi';
    getElement('minPressureUnit').textContent = useMetric ? 'm' : 'psi';
    getElement('demandUnit').textContent = useMetric ? 'L/day' : 'gal/day';
    getElement('fireReserveUnit').textContent = useMetric ? 'L' : 'gal';
    getElement('pumpFlowUnit').textContent = useMetric ? 'L/s' : 'gpm';
    getElement('elevationUnit').textContent = useMetric ? 'm' : 'ft';
    getElement('frictionUnit').textContent = useMetric ? 'm' : 'ft';
    
    // Drainage System Units
    getElement('areaUnit').textContent = useMetric ? 'm¬≤' : 'ft¬≤';
    getElement('intensityUnit').textContent = useMetric ? 'mm/hr' : 'in/hr';
    getElement('septicFlowUnit').textContent = useMetric ? 'L/day' : 'gal/day';
    getElement('greaseFlowUnit').textContent = useMetric ? 'L/s' : 'gpm';
    
    // Pump System Units
    getElement('boosterFlowUnit').textContent = useMetric ? 'L/s' : 'gpm';
    getElement('boosterLiftUnit').textContent = useMetric ? 'm' : 'ft';
    getElement('boosterFrictionUnit').textContent = useMetric ? 'm' : 'ft';
    getElement('sumpVolumeUnit').textContent = useMetric ? 'L' : 'gal';
    getElement('sumpHeadUnit').textContent = useMetric ? 'm' : 'ft';
    getElement('fireFlowUnit').textContent = useMetric ? 'L/s' : 'gpm';
    getElement('fireHeadUnit').textContent = useMetric ? 'm' : 'ft';
    getElement('rainFlowUnit').textContent = useMetric ? 'L/s' : 'gpm';
    getElement('rainHeadUnit').textContent = useMetric ? 'm' : 'ft';
    
    // Special Systems Units
    getElement('standpipeFlowUnit').textContent = useMetric ? 'L/s' : 'gpm';
    getElement('rainAreaUnit').textContent = useMetric ? 'm¬≤' : 'ft¬≤';
    getElement('rainfallUnit').textContent = useMetric ? 'mm/yr' : 'in/yr';
    getElement('rainDemandUnit').textContent = useMetric ? 'L/day' : 'gal/day';
    getElement('stpFlowUnit').textContent = useMetric ? 'm¬≥/day' : 'gal/day';
    
    // Update default values based on code
    updateDefaultValues();
}

// Update default values based on selected code
function updateDefaultValues() {
    const code = CODE_STANDARDS[currentCodeStandard];
    const useMetric = currentUnits === 'metric';
    
    switch(currentCodeStandard) {
        case 'rnpcp':
            // Philippine defaults
            if (useMetric) {
                getElement('waterMinPressure').value = 10; // 10m
                getElement('tankFireReserve').value = 18000; // 18,000L
                getElement('stormIntensity').value = 120; // mm/hr
                getElement('septicFlowPerPerson').value = 150; // L/day
            } else {
                getElement('waterMinPressure').value = 14; // ~10m in psi
                getElement('tankFireReserve').value = 4750; // ~18,000L in gallons
                getElement('stormIntensity').value = 4.7; // ~120mm/hr in in/hr
                getElement('septicFlowPerPerson').value = 40; // ~150L/day in gal/day
            }
            getElement('waterPeakFactor').value = 0.7;
            break;
        case 'ipc':
        case 'upc':
            // US defaults  
            if (useMetric) {
                getElement('waterMinPressure').value = 10.5; // ~15psi in m
                getElement('tankFireReserve').value = 6800; // ~1800gal in L
                getElement('stormIntensity').value = 120; // mm/hr
                getElement('septicFlowPerPerson').value = 150; // L/day
            } else {
                getElement('waterMinPressure').value = 15; // 15psi
                getElement('tankFireReserve').value = 1800; // gal
                getElement('stormIntensity').value = 4.7; // in/hr
                getElement('septicFlowPerPerson').value = 40; // gal/day
            }
            getElement('waterPeakFactor').value = 0.6;
            break;
    }
}

// Tab functionality with accessibility
function initializeTabs() {
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            
            // Update tab states
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
            });
            this.classList.add('active');
            this.setAttribute('aria-selected', 'true');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            getElement(tabId).classList.add('active');
        });
        
        // Keyboard navigation for tabs
        tab.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
    });
}

// Utility functions
function safeNumber(v, fallback=0) {
    if (v === '' || v === null || v === undefined) return fallback;
    const n = Number(v);
    if (isNaN(n)) return fallback;
    return n;
}

function formatNumber(num, dp=2) {
    if (typeof num !== 'number' || isNaN(num)) return '';
    const rounded = Math.round((num+Number.EPSILON)*Math.pow(10,dp))/Math.pow(10,dp);
    return rounded.toLocaleString(undefined, {minimumFractionDigits: dp, maximumFractionDigits: dp});
}

// Convert between metric and imperial units
function convertValue(value, fromUnit, toUnit) {
    if (fromUnit === toUnit) return value;
    
    // Length conversions
    if (fromUnit === 'm' && toUnit === 'ft') return value * CONVERSIONS.m_to_ft;
    if (fromUnit === 'ft' && toUnit === 'm') return value * CONVERSIONS.ft_to_m;
    
    // Volume conversions
    if (fromUnit === 'L' && toUnit === 'gal') return value * CONVERSIONS.l_to_gal;
    if (fromUnit === 'gal' && toUnit === 'L') return value * CONVERSIONS.gal_to_l;
    
    // Flow conversions
    if (fromUnit === 'L/s' && toUnit === 'gpm') return value * CONVERSIONS.lps_to_gpm;
    if (fromUnit === 'gpm' && toUnit === 'L/s') return value * CONVERSIONS.gpm_to_lps;
    
    // Pressure conversions
    if (fromUnit === 'm' && toUnit === 'psi') return value * CONVERSIONS.m_to_psi;
    if (fromUnit === 'psi' && toUnit === 'm') return value * CONVERSIONS.psi_to_m;
    
    // Area conversions
    if (fromUnit === 'm¬≤' && toUnit === 'ft¬≤') return value * CONVERSIONS.m2_to_ft2;
    if (fromUnit === 'ft¬≤' && toUnit === 'm¬≤') return value * CONVERSIONS.ft2_to_m2;
    
    // Rainfall intensity
    if (fromUnit === 'mm/hr' && toUnit === 'in/hr') return value * CONVERSIONS.mmhr_to_inhr;
    if (fromUnit === 'in/hr' && toUnit === 'mm/hr') return value * CONVERSIONS.inhr_to_mmhr;
    
    // Pipe diameter conversions
    if (fromUnit === 'mm' && toUnit === 'in') return value * CONVERSIONS.mm_to_in;
    if (fromUnit === 'in' && toUnit === 'mm') return value * CONVERSIONS.in_to_mm;
    
    return value; // Default to no conversion if units not recognized
}

// Get standard pipe sizes in appropriate units
function getStandardPipeSizes() {
    const useMetric = currentUnits === 'metric';
    
    if (useMetric) {
        return [15, 20, 25, 32, 40, 50, 65, 80, 100, 125, 150, 200];
    } else {
        // Convert metric sizes to imperial (approximate standard sizes)
        return [0.5, 0.75, 1, 1.25, 1.5, 2, 2.5, 3, 4, 5, 6, 8];
    }
}

// Format pipe size for display
function formatPipeSize(size) {
    const useMetric = currentUnits === 'metric';
    
    if (useMetric) {
        return `DN ${size} mm`;
    } else {
        // Convert mm to inches and round to nearest standard size
        const sizeInInches = convertValue(size, 'mm', 'in');
        const standardSizes = getStandardPipeSizes();
        let closestSize = standardSizes[0];
        
        for (const standardSize of standardSizes) {
            if (Math.abs(standardSize - sizeInInches) < Math.abs(closestSize - sizeInInches)) {
                closestSize = standardSize;
            }
        }
        
        return `${closestSize} in`;
    }
}

// ============================================================================
// CALCULATION FUNCTIONS - ALL IMPLEMENTED
// ============================================================================

// Water System Design Calculations
async function calculateWaterSupply() {
    const inputsConfig = [
        { id: 'waterFixtureUnits', min: 0, max: 10000, label: 'Fixture Units' },
        { id: 'waterPeakFactor', min: 0.5, max: 1.0, label: 'Peak Factor' },
        { id: 'waterSupplyPressure', min: 0, max: 1000, label: 'Supply Pressure' },
        { id: 'waterMinPressure', min: 0, max: 100, label: 'Minimum Pressure' }
    ];
    
    if (!validateAllInputs(inputsConfig)) return;
    
    const useMetric = currentUnits === 'metric';
    const fixtureUnits = safeNumber(getElement('waterFixtureUnits').value);
    const peakFactor = safeNumber(getElement('waterPeakFactor').value);
    const supplyPressure = safeNumber(getElement('waterSupplyPressure').value);
    const minPressure = safeNumber(getElement('waterMinPressure').value);
    
    // Hunter's curve: Q = 0.5 √ó ‚àö(Fixture Units) √ó Peak Factor
    const peakFlowLps = 0.5 * Math.sqrt(fixtureUnits) * peakFactor;
    
    // Convert to display units
    let displayFlow = peakFlowLps;
    let flowUnit = 'L/s';
    if (!useMetric) {
        displayFlow = convertValue(peakFlowLps, 'L/s', 'gpm');
        flowUnit = 'gpm';
    }
    
    // Pipe sizing based on flow and velocity
    const targetVelocity = 2.0; // m/s
    const pipeArea = peakFlowLps / 1000 / targetVelocity;
    const pipeDiameterM = Math.sqrt((4 * pipeArea) / Math.PI);
    const pipeDiameterMm = pipeDiameterM * 1000;
    
    // Find standard pipe size
    const standardSizes = getStandardPipeSizes();
    let recommendedSize = standardSizes[0];
    for (const size of standardSizes) {
        const sizeMm = useMetric ? size : convertValue(size, 'in', 'mm');
        if (sizeMm >= pipeDiameterMm) {
            recommendedSize = size;
            break;
        }
    }
    
    // Pressure calculation
    let supplyPressureM = supplyPressure;
    let minPressureM = minPressure;
    if (!useMetric) {
        supplyPressureM = convertValue(supplyPressure, 'psi', 'm');
        minPressureM = convertValue(minPressure, 'psi', 'm');
    }
    const availablePressure = supplyPressureM - minPressureM;
    
    let displayPressure = availablePressure;
    let pressureUnit = 'm';
    if (!useMetric) {
        displayPressure = convertValue(availablePressure, 'm', 'psi');
        pressureUnit = 'psi';
    }
    
    const output = getElement('waterSupplyOutput');
    const contentHTML = `
        <p><strong>Peak Flow Rate:</strong> ${formatNumber(displayFlow)} ${flowUnit}</p>
        <p><strong>Recommended Pipe Size:</strong> ${formatPipeSize(recommendedSize)}</p>
        <p><strong>Available Pressure:</strong> ${formatNumber(displayPressure)} ${pressureUnit}</p>
        <p><strong>Design Velocity:</strong> ${formatNumber(targetVelocity)} m/s</p>
        <div class="formula">Formula: Q = 0.5 √ó ‚àö(Fixture Units) √ó Peak Factor</div>
    `;
    
    output.innerHTML = formatSystemOutput('waterSupply', contentHTML);
    output.style.display = 'block';
    
    designResults.waterSupply = {
        systemType: "Domestic Water Supply",
        application: "Building potable water distribution",
        peakFlow: displayFlow,
        pipeSize: recommendedSize,
        availablePressure: displayPressure,
        flowUnit: flowUnit,
        pressureUnit: pressureUnit
    };
    
    showNotification('Water supply calculation completed successfully!');
}

async function calculateTankSize() {
    const inputsConfig = [
        { id: 'tankPopulation', min: 0, max: 100000, label: 'Population' },
        { id: 'tankDailyDemand', min: 0, max: 1000, label: 'Daily Demand' },
        { id: 'tankEmergencyDays', min: 0, max: 30, label: 'Emergency Days' },
        { id: 'tankFireReserve', min: 0, max: 1000000, label: 'Fire Reserve' }
    ];
    
    if (!validateAllInputs(inputsConfig)) return;
    
    const useMetric = currentUnits === 'metric';
    const population = safeNumber(getElement('tankPopulation').value);
    const dailyDemand = safeNumber(getElement('tankDailyDemand').value);
    const emergencyDays = safeNumber(getElement('tankEmergencyDays').value);
    const fireReserve = safeNumber(getElement('tankFireReserve').value);
    
    // Convert to metric for calculations
    let dailyDemandL = dailyDemand;
    let fireReserveL = fireReserve;
    if (!useMetric) {
        dailyDemandL = convertValue(dailyDemand, 'gal', 'L');
        fireReserveL = convertValue(fireReserve, 'gal', 'L');
    }
    
    const domesticStorageL = population * dailyDemandL * emergencyDays;
    const totalStorageL = domesticStorageL + fireReserveL;
    
    // Convert back for display
    let displayDomestic = domesticStorageL;
    let displayTotal = totalStorageL;
    let displayUnit = 'L';
    if (!useMetric) {
        displayDomestic = convertValue(domesticStorageL, 'L', 'gal');
        displayTotal = convertValue(totalStorageL, 'L', 'gal');
        displayUnit = 'gal';
    }
    
    const output = getElement('tankSizeOutput');
    const contentHTML = `
        <p><strong>Domestic Storage:</strong> ${formatNumber(displayDomestic)} ${displayUnit}</p>
        <p><strong>Fire Reserve:</strong> ${formatNumber(fireReserve)} ${useMetric ? 'L' : 'gal'}</p>
        <p><strong>Total Tank Capacity:</strong> ${formatNumber(displayTotal)} ${displayUnit}</p>
        <p><strong>Emergency Supply:</strong> ${emergencyDays} days</p>
        <div class="formula">Formula: Total = (Population √ó Daily Demand √ó Emergency Days) + Fire Reserve</div>
    `;
    
    output.innerHTML = formatSystemOutput('tankSize', contentHTML);
    output.style.display = 'block';
    
    designResults.tankSize = {
        systemType: "Water Storage System",
        application: "Potable water storage & fire reserve",
        domesticStorage: displayDomestic,
        fireReserve: fireReserve,
        totalStorage: displayTotal,
        storageUnit: displayUnit
    };
    
    showNotification('Tank sizing calculation completed successfully!');
}

async function calculateBoosterPump() {
    const inputsConfig = [
        { id: 'pumpFlow', min: 0, max: 1000, label: 'Pump Flow' },
        { id: 'pumpElevation', min: 0, max: 500, label: 'Elevation' },
        { id: 'pumpFriction', min: 0, max: 100, label: 'Friction Loss' },
        { id: 'pumpSafety', min: 0, max: 100, label: 'Safety Margin' }
    ];
    
    if (!validateAllInputs(inputsConfig)) return;
    
    const useMetric = currentUnits === 'metric';
    const flow = safeNumber(getElement('pumpFlow').value);
    const elevation = safeNumber(getElement('pumpElevation').value);
    const friction = safeNumber(getElement('pumpFriction').value);
    const safety = safeNumber(getElement('pumpSafety').value);
    
    // Convert to metric
    let flowLps = flow;
    let elevationM = elevation;
    let frictionM = friction;
    if (!useMetric) {
        flowLps = convertValue(flow, 'gpm', 'L/s');
        elevationM = convertValue(elevation, 'ft', 'm');
        frictionM = convertValue(friction, 'ft', 'm');
    }
    
    const tdh = elevationM + frictionM;
    const tdhWithSafety = tdh * (1 + safety/100);
    
    // Pump power: P = (œÅ √ó g √ó Q √ó H) / Œ∑
    const density = 1000; // kg/m¬≥
    const gravity = 9.81; // m/s¬≤
    const efficiency = 0.7;
    const flowM3s = flowLps / 1000;
    const powerWatts = (density * gravity * flowM3s * tdhWithSafety) / efficiency;
    const powerKW = powerWatts / 1000;
    const powerHP = powerKW / 0.7457;
    
    // Convert back for display
    let displayFlow = flow;
    let flowUnit = useMetric ? 'L/s' : 'gpm';
    let displayTDH = tdhWithSafety;
    let tdhUnit = useMetric ? 'm' : 'ft';
    if (!useMetric) {
        displayTDH = convertValue(tdhWithSafety, 'm', 'ft');
    }
    
    const output = getElement('boosterPumpOutput');
    const contentHTML = `
        <p><strong>Total Dynamic Head (TDH):</strong> ${formatNumber(displayTDH)} ${tdhUnit}</p>
        <p><strong>Required Flow:</strong> ${formatNumber(displayFlow)} ${flowUnit}</p>
        <p><strong>Pump Power:</strong> ${formatNumber(powerKW)} kW (${formatNumber(powerHP)} HP)</p>
        <p><strong>Safety Margin:</strong> ${safety}%</p>
        <div class="formula">Formula: TDH = Static Head + Friction Loss | Power = (œÅ √ó g √ó Q √ó H) / Œ∑</div>
    `;
    
    output.innerHTML = formatSystemOutput('boosterPump', contentHTML);
    output.style.display = 'block';
    
    designResults.boosterPump = {
        systemType: "Domestic Water Booster Pump",
        application: "Basic sizing for domestic water pressure boosting",
        tdh: displayTDH,
        flow: displayFlow,
        powerKW: powerKW,
        powerHP: powerHP,
        tdhUnit: tdhUnit,
        flowUnit: flowUnit
    };
    
    showNotification('Domestic water booster pump calculation completed successfully!');
}

async function calculateHotWaterDemand() {
    const inputsConfig = [
        { id: 'hotWaterBathrooms', min: 0, max: 1000, label: 'Number of Bathrooms' },
        { id: 'hotWaterSimultaneous', min: 0, max: 100, label: 'Simultaneous Use' },
        { id: 'hotWaterFraction', min: 0, max: 1, label: 'Hot Fraction' }
    ];
    
    if (!validateAllInputs(inputsConfig)) return;
    
    const useMetric = currentUnits === 'metric';
    const bathrooms = safeNumber(getElement('hotWaterBathrooms').value);
    const simultaneous = safeNumber(getElement('hotWaterSimultaneous').value);
    const hotFraction = safeNumber(getElement('hotWaterFraction').value);
    
    const fixturesPerBathroom = 2;
    const flowPerFixture = 0.15; // L/s
    const totalFixtures = bathrooms * fixturesPerBathroom;
    const simultaneousFixtures = Math.ceil(totalFixtures * (simultaneous / 100));
    const peakFlowLps = simultaneousFixtures * flowPerFixture;
    const peakHotFlowLps = peakFlowLps * hotFraction;
    
    let displayFlow = peakHotFlowLps;
    let flowUnit = 'L/s';
    if (!useMetric) {
        displayFlow = convertValue(peakHotFlowLps, 'L/s', 'gpm');
        flowUnit = 'gpm';
    }
    
    const output = getElement('hotWaterOutput');
    const contentHTML = `
        <p><strong>Total Fixtures:</strong> ${totalFixtures}</p>
        <p><strong>Simultaneous Fixtures:</strong> ${simultaneousFixtures}</p>
        <p><strong>Peak Hot Water Flow:</strong> ${formatNumber(displayFlow)} ${flowUnit}</p>
        <p><strong>Hot Water Fraction:</strong> ${formatNumber(hotFraction * 100)}%</p>
        <div class="formula">Formula: Peak Hot Flow = (Fixtures √ó Simultaneous Use % √ó Flow per Fixture) √ó Hot Fraction</div>
    `;
    
    output.innerHTML = formatSystemOutput('hotWater', contentHTML);
    output.style.display = 'block';
    
    designResults.hotWater = {
        systemType: "Hot Water System",
        application: "Hot water distribution",
        peakHotFlow: displayFlow,
        simultaneousFixtures: simultaneousFixtures,
        flowUnit: flowUnit
    };
    
    showNotification('Hot water demand calculation completed successfully!');
}

// Drainage System Calculations
async function calculateSewerLoad() {
    const inputsConfig = [
        { id: 'sewerDFU', min: 0, max: 10000, label: 'Drainage Fixture Units' }
    ];
    
    if (!validateAllInputs(inputsConfig)) return;
    
    const useMetric = currentUnits === 'metric';
    const dfu = safeNumber(getElement('sewerDFU').value);
    const slope = safeNumber(getElement('sewerSlope').value);
    const fixtureType = getElement('sewerFixtureType').value;
    
    // DFU to flow conversion: 1 DFU ‚âà 0.47 L/s
    const equivalentFlowLps = dfu * 0.47;
    
    // Pipe sizing based on DFU
    let pipeSizeMm = 50;
    if (dfu <= 20) pipeSizeMm = 50;
    else if (dfu <= 160) pipeSizeMm = 100;
    else if (dfu <= 360) pipeSizeMm = 150;
    else pipeSizeMm = 200;
    
    // Fixture type multiplier
    let typeMultiplier = 1.0;
    switch(fixtureType) {
        case 'commercial': typeMultiplier = 1.2; break;
        case 'institutional': typeMultiplier = 1.5; break;
    }
    const adjustedFlowLps = equivalentFlowLps * typeMultiplier;
    
    // Convert for display
    let displayFlow = equivalentFlowLps;
    let displayAdjustedFlow = adjustedFlowLps;
    let flowUnit = 'L/s';
    if (!useMetric) {
        displayFlow = convertValue(equivalentFlowLps, 'L/s', 'gpm');
        displayAdjustedFlow = convertValue(adjustedFlowLps, 'L/s', 'gpm');
        flowUnit = 'gpm';
    }
    
    const output = getElement('sewerOutput');
    const contentHTML = `
        <p><strong>Total DFU:</strong> ${dfu}</p>
        <p><strong>Equivalent Flow:</strong> ${formatNumber(displayFlow)} ${flowUnit}</p>
        <p><strong>Adjusted Flow:</strong> ${formatNumber(displayAdjustedFlow)} ${flowUnit}</p>
        <p><strong>Recommended Pipe Size:</strong> ${formatPipeSize(pipeSizeMm)}</p>
        <p><strong>Minimum Slope:</strong> ${formatNumber(slope * 100)}%</p>
        <div class="formula">Formula: Equivalent Flow = DFU √ó 0.47 L/s</div>
    `;
    
    output.innerHTML = formatSystemOutput('sewer', contentHTML);
    output.style.display = 'block';
    
    designResults.sewer = {
        systemType: "Sanitary Drainage System",
        application: "Building wastewater drainage",
        dfu: dfu,
        equivalentFlow: displayFlow,
        adjustedFlow: displayAdjustedFlow,
        pipeSize: pipeSizeMm,
        flowUnit: flowUnit
    };
    
    showNotification('Sewer load calculation completed successfully!');
}

async function calculateStormFlow() {
    const inputsConfig = [
        { id: 'stormArea', min: 0, max: 100000, label: 'Roof Area' },
        { id: 'stormIntensity', min: 0, max: 500, label: 'Rain Intensity' }
    ];
    
    if (!validateAllInputs(inputsConfig)) return;
    
    const useMetric = currentUnits === 'metric';
    const area = safeNumber(getElement('stormArea').value);
    const intensity = safeNumber(getElement('stormIntensity').value);
    const coefficient = safeNumber(getElement('stormCoefficient').value);
    
    // Rational method: Q = C √ó I √ó A
    let areaM2 = area;
    let intensityMhr = intensity;
    if (!useMetric) {
        areaM2 = convertValue(area, 'ft¬≤', 'm¬≤');
        intensityMhr = convertValue(intensity, 'in/hr', 'mm/hr');
    }
    
    const intensityMs = intensityMhr / (1000 * 3600);
    const flowM3s = coefficient * intensityMs * areaM2;
    
    let displayFlow = flowM3s * 1000; // L/s
    let displayUnit = 'L/s';
    if (!useMetric) {
        displayFlow = convertValue(displayFlow, 'L/s', 'gpm');
        displayUnit = 'gpm';
    }
    
    const output = getElement('stormOutput');
    const contentHTML = `
        <p><strong>Roof Area:</strong> ${formatNumber(area)} ${useMetric ? 'm¬≤' : 'ft¬≤'}</p>
        <p><strong>Rain Intensity:</strong> ${formatNumber(intensity)} ${useMetric ? 'mm/hr' : 'in/hr'}</p>
        <p><strong>Runoff Coefficient:</strong> ${coefficient}</p>
        <p><strong>Peak Storm Flow:</strong> ${formatNumber(displayFlow)} ${displayUnit}</p>
        <div class="formula">Formula: Q = C √ó I √ó A (Rational Method)</div>
    `;
    
    output.innerHTML = formatSystemOutput('storm', contentHTML);
    output.style.display = 'block';
    
    designResults.storm = {
        systemType: "Storm Drainage System",
        application: "Roof & surface water drainage",
        area: area,
        intensity: intensity,
        peakFlow: displayFlow,
        flowUnit: displayUnit,
        areaUnit: useMetric ? 'm¬≤' : 'ft¬≤',
        intensityUnit: useMetric ? 'mm/hr' : 'in/hr'
    };
    
    showNotification('Storm drainage calculation completed successfully!');
}

async function calculateSepticTank() {
    const inputsConfig = [
        { id: 'septicPersons', min: 0, max: 10000, label: 'Number of Persons' },
        { id: 'septicFlowPerPerson', min: 0, max: 1000, label: 'Flow per Person' },
        { id: 'septicRetention', min: 0, max: 168, label: 'Retention Time' }
    ];
    
    if (!validateAllInputs(inputsConfig)) return;
    
    const useMetric = currentUnits === 'metric';
    const persons = safeNumber(getElement('septicPersons').value);
    const flowPerPerson = safeNumber(getElement('septicFlowPerPerson').value);
    const retention = safeNumber(getElement('septicRetention').value);
    const compartments = safeNumber(getElement('septicCompartments').value);
    
    let flowPerPersonL = flowPerPerson;
    if (!useMetric) {
        flowPerPersonL = convertValue(flowPerPerson, 'gal', 'L');
    }
    
    const dailyFlowL = persons * flowPerPersonL;
    const retentionDays = retention / 24;
    const requiredVolumeL = dailyFlowL * retentionDays;
    
    const compartmentFactor = compartments === 1 ? 1.0 : (compartments === 2 ? 0.67 : 0.5);
    const adjustedVolumeL = requiredVolumeL / compartmentFactor;
    
    let displayVolume = adjustedVolumeL;
    let displayUnit = 'L';
    if (!useMetric) {
        displayVolume = convertValue(adjustedVolumeL, 'L', 'gal');
        displayUnit = 'gal';
    }
    
    const output = getElement('septicOutput');
    const contentHTML = `
        <p><strong>Number of Persons:</strong> ${persons}</p>
        <p><strong>Daily Flow:</strong> ${formatNumber(dailyFlowL)} ${useMetric ? 'L/day' : 'gal/day'}</p>
        <p><strong>Retention Time:</strong> ${retention} hours</p>
        <p><strong>Compartments:</strong> ${compartments}</p>
        <p><strong>Required Tank Volume:</strong> ${formatNumber(displayVolume)} ${displayUnit}</p>
        <div class="formula">Formula: Volume = (Persons √ó Flow per Person √ó Retention Time) / Compartment Factor</div>
    `;
    
    output.innerHTML = formatSystemOutput('septic', contentHTML);
    output.style.display = 'block';
    
    designResults.septic = {
        systemType: "Septic System",
        application: "On-site wastewater treatment",
        dailyFlow: dailyFlowL,
        retentionTime: retention,
        tankVolume: displayVolume,
        volumeUnit: displayUnit
    };
    
    showNotification('Septic tank calculation completed successfully!');
}

async function calculateGreaseTrap() {
    const inputsConfig = [
        { id: 'greaseFlow', min: 0, max: 100, label: 'Flow Rate' },
        { id: 'greaseRetention', min: 0, max: 120, label: 'Retention Time' }
    ];
    
    if (!validateAllInputs(inputsConfig)) return;
    
    const useMetric = currentUnits === 'metric';
    const fixtureType = getElement('greaseFixtureType').value;
    const flow = safeNumber(getElement('greaseFlow').value);
    const retention = safeNumber(getElement('greaseRetention').value);
    
    let fixtureFactor = 1.0;
    switch(fixtureType) {
        case 'sink': fixtureFactor = 1.0; break;
        case 'dishwasher': fixtureFactor = 1.5; break;
        case 'floor': fixtureFactor = 2.0; break;
        case 'multiple': fixtureFactor = 2.5; break;
    }
    
    let flowLps = flow;
    if (!useMetric) {
        flowLps = convertValue(flow, 'gpm', 'L/s');
    }
    
    const retentionHours = retention / 60;
    const requiredVolumeL = flowLps * 3600 * retentionHours * fixtureFactor;
    
    let displayVolume = requiredVolumeL;
    let displayUnit = 'L';
    if (!useMetric) {
        displayVolume = convertValue(requiredVolumeL, 'L', 'gal');
        displayUnit = 'gal';
    }
    
    const output = getElement('greaseOutput');
    const contentHTML = `
        <p><strong>Fixture Type:</strong> ${fixtureType}</p>
        <p><strong>Flow Rate:</strong> ${formatNumber(flow)} ${useMetric ? 'L/s' : 'gpm'}</p>
        <p><strong>Retention Time:</strong> ${retention} minutes</p>
        <p><strong>Required Grease Trap Volume:</strong> ${formatNumber(displayVolume)} ${displayUnit}</p>
        <div class="formula">Formula: Volume = Flow √ó Retention Time √ó Fixture Factor</div>
    `;
    
    output.innerHTML = formatSystemOutput('greaseTrap', contentHTML);
    output.style.display = 'block';
    
    designResults.greaseTrap = {
        systemType: "Grease Interceptor System",
        application: "Kitchen wastewater pretreatment",
        fixtureType: fixtureType,
        flow: flow,
        volume: displayVolume,
        volumeUnit: displayUnit
    };
    
    showNotification('Grease trap calculation completed successfully!');
}

// Pump System Calculations
async function calculateBoosterPump2() {
    const inputsConfig = [
        { id: 'boosterFlow', min: 0, max: 1000, label: 'Booster Flow' },
        { id: 'boosterLift', min: 0, max: 500, label: 'Static Lift' },
        { id: 'boosterFriction', min: 0, max: 100, label: 'Friction Loss' },
        { id: 'boosterEfficiency', min: 0, max: 100, label: 'Efficiency' }
    ];
    
    if (!validateAllInputs(inputsConfig)) return;
    
    const useMetric = currentUnits === 'metric';
    const flow = safeNumber(getElement('boosterFlow').value);
    const lift = safeNumber(getElement('boosterLift').value);
    const friction = safeNumber(getElement('boosterFriction').value);
    const efficiency = safeNumber(getElement('boosterEfficiency').value);
    
    let flowLps = flow;
    let liftM = lift;
    let frictionM = friction;
    if (!useMetric) {
        flowLps = convertValue(flow, 'gpm', 'L/s');
        liftM = convertValue(lift, 'ft', 'm');
        frictionM = convertValue(friction, 'ft', 'm');
    }
    
    const tdh = liftM + frictionM;
    const efficiencyDecimal = efficiency / 100;
    const flowM3s = flowLps / 1000;
    const powerWatts = (1000 * 9.81 * flowM3s * tdh) / efficiencyDecimal;
    const powerKW = powerWatts / 1000;
    const powerHP = powerKW / 0.7457;
    
    let displayFlow = flow;
    let flowUnit = useMetric ? 'L/s' : 'gpm';
    let displayTDH = tdh;
    let tdhUnit = useMetric ? 'm' : 'ft';
    if (!useMetric) {
        displayTDH = convertValue(tdh, 'm', 'ft');
    }
    
    const output = getElement('boosterOutput');
    const contentHTML = `
        <p><strong>Total Dynamic Head (TDH):</strong> ${formatNumber(displayTDH)} ${tdhUnit}</p>
        <p><strong>Required Flow:</strong> ${formatNumber(displayFlow)} ${flowUnit}</p>
        <p><strong>Pump Power:</strong> ${formatNumber(powerKW)} kW (${formatNumber(powerHP)} HP)</p>
        <p><strong>Pump Efficiency:</strong> ${efficiency}%</p>
        <div class="formula">Formula: Power = (œÅ √ó g √ó Q √ó H) / Œ∑</div>
    `;
    
    output.innerHTML = formatSystemOutput('boosterPump2', contentHTML);
    output.style.display = 'block';
    
    designResults.boosterPump2 = {
        systemType: "Booster Pump Power Analysis",
        application: "Detailed power calculation for pump specification",
        tdh: displayTDH,
        flow: displayFlow,
        powerKW: powerKW,
        powerHP: powerHP,
        tdhUnit: tdhUnit,
        flowUnit: flowUnit
    };
    
    showNotification('Booster pump power calculation completed successfully!');
}

async function calculateSumpPump() {
    const inputsConfig = [
        { id: 'sumpVolume', min: 0, max: 100000, label: 'Sump Volume' },
        { id: 'sumpTime', min: 0, max: 1440, label: 'Emptying Time' },
        { id: 'sumpHead', min: 0, max: 100, label: 'Static Head' }
    ];
    
    if (!validateAllInputs(inputsConfig)) return;
    
    const useMetric = currentUnits === 'metric';
    const volume = safeNumber(getElement('sumpVolume').value);
    const time = safeNumber(getElement('sumpTime').value);
    const head = safeNumber(getElement('sumpHead').value);
    const application = getElement('sumpApplication').value;
    
    let volumeL = volume;
    let headM = head;
    if (!useMetric) {
        volumeL = convertValue(volume, 'gal', 'L');
        headM = convertValue(head, 'ft', 'm');
    }
    
    const timeSeconds = time * 60;
    const flowLps = volumeL / timeSeconds;
    const efficiency = 0.6;
    const flowM3s = flowLps / 1000;
    const powerWatts = (1000 * 9.81 * flowM3s * headM) / efficiency;
    const powerKW = powerWatts / 1000;
    const powerHP = powerKW / 0.7457;
    
    let displayFlow = flowLps;
    let flowUnit = useMetric ? 'L/s' : 'gpm';
    let displayHead = head;
    let headUnit = useMetric ? 'm' : 'ft';
    if (!useMetric) {
        displayFlow = convertValue(flowLps, 'L/s', 'gpm');
    }
    
    const output = getElement('sumpOutput');
    const contentHTML = `
        <p><strong>Required Flow Rate:</strong> ${formatNumber(displayFlow)} ${flowUnit}</p>
        <p><strong>Static Head:</strong> ${formatNumber(displayHead)} ${headUnit}</p>
        <p><strong>Pump Power:</strong> ${formatNumber(powerKW)} kW (${formatNumber(powerHP)} HP)</p>
        <p><strong>Application:</strong> ${application}</p>
        <p><strong>Emptying Time:</strong> ${time} minutes</p>
        <div class="formula">Formula: Q = Volume / Time | Power = (œÅ √ó g √ó Q √ó H) / Œ∑</div>
    `;
    
    output.innerHTML = formatSystemOutput('sumpPump', contentHTML);
    output.style.display = 'block';
    
    designResults.sumpPump = {
        systemType: "Sump Pump System",
        application: `${application} drainage`,
        flow: displayFlow,
        head: displayHead,
        powerKW: powerKW,
        powerHP: powerHP,
        flowUnit: flowUnit,
        headUnit: headUnit
    };
    
    showNotification('Sump pump calculation completed successfully!');
}

async function calculateFirePump() {
    const inputsConfig = [
        { id: 'firePumpFlow', min: 0, max: 1000, label: 'Fire Pump Flow' },
        { id: 'firePumpTDH', min: 0, max: 500, label: 'Total Dynamic Head' },
        { id: 'firePumpEfficiency', min: 0, max: 100, label: 'Pump Efficiency' }
    ];
    
    if (!validateAllInputs(inputsConfig)) return;
    
    const useMetric = currentUnits === 'metric';
    const flow = safeNumber(getElement('firePumpFlow').value);
    const tdh = safeNumber(getElement('firePumpTDH').value);
    const efficiency = safeNumber(getElement('firePumpEfficiency').value);
    const buildingType = getElement('fireBuildingType').value;
    
    let flowLps = flow;
    let tdhM = tdh;
    if (!useMetric) {
        flowLps = convertValue(flow, 'gpm', 'L/s');
        tdhM = convertValue(tdh, 'ft', 'm');
    }
    
    const efficiencyDecimal = efficiency / 100;
    const flowM3s = flowLps / 1000;
    const powerWatts = (1000 * 9.81 * flowM3s * tdhM) / efficiencyDecimal;
    const powerKW = powerWatts / 1000;
    const powerHP = powerKW / 0.7457;
    
    let displayFlow = flow;
    let flowUnit = useMetric ? 'L/s' : 'gpm';
    let displayTDH = tdh;
    let tdhUnit = useMetric ? 'm' : 'ft';
    if (!useMetric) {
        displayTDH = convertValue(tdhM, 'm', 'ft');
    }
    
    const output = getElement('firePumpOutput');
    const contentHTML = `
        <p><strong>Required Flow:</strong> ${formatNumber(displayFlow)} ${flowUnit}</p>
        <p><strong>Total Dynamic Head:</strong> ${formatNumber(displayTDH)} ${tdhUnit}</p>
        <p><strong>Pump Power:</strong> ${formatNumber(powerKW)} kW (${formatNumber(powerHP)} HP)</p>
        <p><strong>Pump Efficiency:</strong> ${efficiency}%</p>
        <p><strong>Building Type:</strong> ${buildingType}</p>
        <div class="formula">Formula: Power = (œÅ √ó g √ó Q √ó H) / Œ∑</div>
    `;
    
    output.innerHTML = formatSystemOutput('firePump', contentHTML);
    output.style.display = 'block';
    
    designResults.firePump = {
        systemType: "Fire Protection Pump System",
        application: "Fire protection water supply",
        flow: displayFlow,
        tdh: displayTDH,
        powerKW: powerKW,
        powerHP: powerHP,
        flowUnit: flowUnit,
        tdhUnit: tdhUnit
    };
    
    showNotification('Fire pump calculation completed successfully!');
}

async function calculateRainwaterPump() {
    const inputsConfig = [
        { id: 'rainPumpFlow', min: 0, max: 1000, label: 'Rainwater Pump Flow' },
        { id: 'rainPumpTDH', min: 0, max: 500, label: 'Total Dynamic Head' },
        { id: 'rainPumpEfficiency', min: 0, max: 100, label: 'Pump Efficiency' }
    ];
    
    if (!validateAllInputs(inputsConfig)) return;
    
    const useMetric = currentUnits === 'metric';
    const flow = safeNumber(getElement('rainPumpFlow').value);
    const tdh = safeNumber(getElement('rainPumpTDH').value);
    const efficiency = safeNumber(getElement('rainPumpEfficiency').value);
    const usageType = getElement('rainUsageType').value;
    
    let flowLps = flow;
    let tdhM = tdh;
    if (!useMetric) {
        flowLps = convertValue(flow, 'gpm', 'L/s');
        tdhM = convertValue(tdh, 'ft', 'm');
    }
    
    const efficiencyDecimal = efficiency / 100;
    const flowM3s = flowLps / 1000;
    const powerWatts = (1000 * 9.81 * flowM3s * tdhM) / efficiencyDecimal;
    const powerKW = powerWatts / 1000;
    const powerHP = powerKW / 0.7457;
    
    let displayFlow = flow;
    let flowUnit = useMetric ? 'L/s' : 'gpm';
    let displayTDH = tdh;
    let tdhUnit = useMetric ? 'm' : 'ft';
    if (!useMetric) {
        displayTDH = convertValue(tdhM, 'm', 'ft');
    }
    
    const output = getElement('rainwaterPumpOutput');
    const contentHTML = `
        <p><strong>Required Flow:</strong> ${formatNumber(displayFlow)} ${flowUnit}</p>
        <p><strong>Total Dynamic Head:</strong> ${formatNumber(displayTDH)} ${tdhUnit}</p>
        <p><strong>Pump Power:</strong> ${formatNumber(powerKW)} kW (${formatNumber(powerHP)} HP)</p>
        <p><strong>Pump Efficiency:</strong> ${efficiency}%</p>
        <p><strong>Usage Type:</strong> ${usageType}</p>
        <div class="formula">Formula: Power = (œÅ √ó g √ó Q √ó H) / Œ∑</div>
    `;
    
    output.innerHTML = formatSystemOutput('rainwaterPump', contentHTML);
    output.style.display = 'block';
    
    designResults.rainwaterPump = {
        systemType: "Rainwater Pump System",
        application: "Rainwater collection & reuse",
        flow: displayFlow,
        tdh: displayTDH,
        powerKW: powerKW,
        powerHP: powerHP,
        flowUnit: flowUnit,
        tdhUnit: tdhUnit
    };
    
    showNotification('Rainwater pump calculation completed successfully!');
}

// Special Systems Calculations
async function calculateFireDemand() {
    const inputsConfig = [
        { id: 'standpipeCount', min: 0, max: 100, label: 'Number of Standpipes' },
        { id: 'standpipeFlow', min: 0, max: 1000, label: 'Flow per Standpipe' },
        { id: 'standpipeDuration', min: 0, max: 240, label: 'Fire Duration' }
    ];
    
    if (!validateAllInputs(inputsConfig)) return;
    
    const useMetric = currentUnits === 'metric';
    const standpipeCount = safeNumber(getElement('standpipeCount').value);
    const standpipeFlow = safeNumber(getElement('standpipeFlow').value);
    const duration = safeNumber(getElement('standpipeDuration').value);
    const buildingHeight = getElement('buildingHeight').value;
    
    let standpipeFlowLps = standpipeFlow;
    if (!useMetric) {
        standpipeFlowLps = convertValue(standpipeFlow, 'gpm', 'L/s');
    }
    
    const totalFlowLps = standpipeCount * standpipeFlowLps;
    const durationHours = duration / 60;
    const totalVolumeL = totalFlowLps * 3600 * durationHours;
    
    let heightFactor = 1.0;
    switch(buildingHeight) {
        case 'medium': heightFactor = 1.2; break;
        case 'high': heightFactor = 1.5; break;
    }
    
    let displayTotalFlow = totalFlowLps;
    let flowUnit = 'L/s';
    let displayTotalVolume = totalVolumeL * heightFactor;
    let volumeUnit = 'L';
    if (!useMetric) {
        displayTotalFlow = convertValue(totalFlowLps, 'L/s', 'gpm');
        flowUnit = 'gpm';
        displayTotalVolume = convertValue(totalVolumeL * heightFactor, 'L', 'gal');
        volumeUnit = 'gal';
    }
    
    const output = getElement('fireDemandOutput');
    const contentHTML = `
        <p><strong>Number of Standpipes:</strong> ${standpipeCount}</p>
        <p><strong>Flow per Standpipe:</strong> ${formatNumber(standpipeFlow)} ${useMetric ? 'L/s' : 'gpm'}</p>
        <p><strong>Total Flow Required:</strong> ${formatNumber(displayTotalFlow)} ${flowUnit}</p>
        <p><strong>Duration:</strong> ${duration} minutes</p>
        <p><strong>Building Height:</strong> ${buildingHeight}</p>
        <p><strong>Total Water Volume:</strong> ${formatNumber(displayTotalVolume)} ${volumeUnit}</p>
        <div class="formula">Formula: Total Volume = (Standpipes √ó Flow √ó Duration) √ó Height Factor</div>
    `;
    
    output.innerHTML = formatSystemOutput('fireDemand', contentHTML);
    output.style.display = 'block';
    
    designResults.fireDemand = {
        systemType: "Fire Protection System",
        application: "Fire fighting water demand",
        totalFlow: displayTotalFlow,
        totalVolume: displayTotalVolume,
        flowUnit: flowUnit,
        volumeUnit: volumeUnit
    };
    
    showNotification('Fire demand calculation completed successfully!');
}

async function calculateRainwaterTank() {
    const inputsConfig = [
        { id: 'rainRoofArea', min: 0, max: 100000, label: 'Roof Area' },
        { id: 'rainRainfall', min: 0, max: 10000, label: 'Annual Rainfall' },
        { id: 'rainEfficiency', min: 0, max: 100, label: 'Collection Efficiency' },
        { id: 'rainDemand', min: 0, max: 1000000, label: 'Daily Water Demand' }
    ];
    
    if (!validateAllInputs(inputsConfig)) return;
    
    const useMetric = currentUnits === 'metric';
    const roofArea = safeNumber(getElement('rainRoofArea').value);
    const rainfall = safeNumber(getElement('rainRainfall').value);
    const efficiency = safeNumber(getElement('rainEfficiency').value);
    const dailyDemand = safeNumber(getElement('rainDemand').value);
    
    let roofAreaM2 = roofArea;
    let rainfallM = rainfall;
    let dailyDemandL = dailyDemand;
    if (!useMetric) {
        roofAreaM2 = convertValue(roofArea, 'ft¬≤', 'm¬≤');
        rainfallM = convertValue(rainfall, 'in', 'mm') / 1000;
        dailyDemandL = convertValue(dailyDemand, 'gal', 'L');
    } else {
        rainfallM = rainfall / 1000;
    }
    
    const efficiencyDecimal = efficiency / 100;
    const annualCollectionM3 = roofAreaM2 * rainfallM * efficiencyDecimal;
    const annualCollectionL = annualCollectionM3 * 1000;
    
    const storageDays = 15;
    const requiredStorageL = dailyDemandL * storageDays;
    const recommendedStorageL = Math.min(annualCollectionL, requiredStorageL);
    
    let displayStorage = recommendedStorageL;
    let storageUnit = 'L';
    let displayAnnual = annualCollectionL;
    let annualUnit = 'L';
    if (!useMetric) {
        displayStorage = convertValue(recommendedStorageL, 'L', 'gal');
        storageUnit = 'gal';
        displayAnnual = convertValue(annualCollectionL, 'L', 'gal');
        annualUnit = 'gal';
    }
    
    const output = getElement('rainwaterTankOutput');
    const contentHTML = `
        <p><strong>Roof Area:</strong> ${formatNumber(roofArea)} ${useMetric ? 'm¬≤' : 'ft¬≤'}</p>
        <p><strong>Annual Rainfall:</strong> ${formatNumber(rainfall)} ${useMetric ? 'mm/yr' : 'in/yr'}</p>
        <p><strong>Collection Efficiency:</strong> ${efficiency}%</p>
        <p><strong>Daily Water Demand:</strong> ${formatNumber(dailyDemand)} ${useMetric ? 'L/day' : 'gal/day'}</p>
        <p><strong>Annual Collection Potential:</strong> ${formatNumber(displayAnnual)} ${annualUnit}</p>
        <p><strong>Recommended Tank Size:</strong> ${formatNumber(displayStorage)} ${storageUnit}</p>
        <p><strong>Storage Period:</strong> ${storageDays} days</p>
        <div class="formula">Formula: Annual Collection = Area √ó Rainfall √ó Efficiency</div>
    `;
    
    output.innerHTML = formatSystemOutput('rainwaterTank', contentHTML);
    output.style.display = 'block';
    
    designResults.rainwaterTank = {
        systemType: "Rainwater Harvesting System",
        application: "Rainwater storage & reuse",
        annualCollection: displayAnnual,
        tankSize: displayStorage,
        annualUnit: annualUnit,
        storageUnit: storageUnit
    };
    
    showNotification('Rainwater tank calculation completed successfully!');
}

async function calculateSTPVolume() {
    const inputsConfig = [
        { id: 'stpFlow', min: 0, max: 100000, label: 'Wastewater Flow' },
        { id: 'stpBOD', min: 0, max: 1000, label: 'BOD5 Influent' }
    ];
    
    if (!validateAllInputs(inputsConfig)) return;
    
    const useMetric = currentUnits === 'metric';
    const flow = safeNumber(getElement('stpFlow').value);
    const bod = safeNumber(getElement('stpBOD').value);
    const treatmentType = getElement('stpTreatment').value;
    const effluentQuality = getElement('stpEffluent').value;
    
    let flowM3d = flow;
    if (!useMetric) {
        flowM3d = convertValue(flow, 'gal', 'L') / 1000;
    }
    
    let treatmentFactor = 1.0;
    switch(treatmentType) {
        case 'mbbr': treatmentFactor = 0.8; break;
        case 'mbr': treatmentFactor = 0.6; break;
        case 'sbr': treatmentFactor = 0.7; break;
        case 'activated': treatmentFactor = 1.0; break;
    }
    
    let qualityFactor = 1.0;
    switch(effluentQuality) {
        case 'class_b': qualityFactor = 1.2; break;
        case 'reuse': qualityFactor = 1.5; break;
    }
    
    const hydraulicRetentionTime = 24;
    const volumeM3 = flowM3d * (hydraulicRetentionTime / 24) * treatmentFactor * qualityFactor;
    
    let displayVolume = volumeM3;
    let volumeUnit = 'm¬≥';
    if (!useMetric) {
        displayVolume = convertValue(volumeM3, 'm¬≥', 'gal');
        volumeUnit = 'gal';
    }
    
    const output = getElement('stpVolumeOutput');
    const contentHTML = `
        <p><strong>Daily Wastewater Flow:</strong> ${formatNumber(flow)} ${useMetric ? 'm¬≥/day' : 'gal/day'}</p>
        <p><strong>BOD5 Influent:</strong> ${bod} mg/L</p>
        <p><strong>Treatment Type:</strong> ${treatmentType}</p>
        <p><strong>Effluent Quality:</strong> ${effluentQuality}</p>
        <p><strong>Recommended STP Volume:</strong> ${formatNumber(displayVolume)} ${volumeUnit}</p>
        <p><strong>Hydraulic Retention Time:</strong> ${hydraulicRetentionTime} hours</p>
        <div class="formula">Formula: Volume = Flow √ó HRT √ó Treatment Factor √ó Quality Factor</div>
    `;
    
    output.innerHTML = formatSystemOutput('stpVolume', contentHTML);
    output.style.display = 'block';
    
    designResults.stpVolume = {
        systemType: "Sewage Treatment System",
        application: "Wastewater treatment",
        volume: displayVolume,
        volumeUnit: volumeUnit
    };
    
    showNotification('STP volume calculation completed successfully!');
}

// Update DFU Table with proper data
function updateDFUTable() {
    const code = getElement('dfuCodeSelect').value;
    const dfuData = DFU_TABLES[code] || DFU_TABLES.rnpcp;
    
    const output = getElement('dfuTableOutput');
    
    let tableHTML = `
        <h4>${CODE_STANDARDS[code].name} DFU Table</h4>
        <table class="reference-table" aria-label="Drainage Fixture Unit Table for ${CODE_STANDARDS[code].name}">
            <thead>
                <tr>
                    <th scope="col">Fixture</th>
                    <th scope="col">DFU (Private)</th>
                    <th scope="col">DFU (Public)</th>
                    <th scope="col">Min Pipe Size</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    dfuData.forEach(row => {
        tableHTML += `
            <tr>
                <td>${sanitize(row.fixture)}</td>
                <td>${row.private}</td>
                <td>${row.public}</td>
                <td>${sanitize(row.minPipe)}</td>
            </tr>
        `;
    });
    
    tableHTML += `</tbody></table>`;
    output.innerHTML = tableHTML;
    output.style.display = 'block';
}

// Project management functions
async function saveProjectAsJSON() {
    try {
        const button = getElement('saveProjectBtn');
        button.classList.add('loading');
        button.disabled = true;
        
        const projectData = {
            projectName: getElement('projectName').value,
            clientName: getElement('clientName').value,
            location: getElement('projectLocation').value,
            preparedBy: getElement('preparedBy').value,
            codeStandard: currentCodeStandard,
            units: currentUnits,
            designResults: designResults,
            timestamp: new Date().toISOString()
        };
        
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectData, null, 2));
        const downloadAnchor = document.createElement('a');
        downloadAnchor.setAttribute("href", dataStr);
        downloadAnchor.setAttribute("download", "plumbing_design_project.json");
        document.body.appendChild(downloadAnchor);
        downloadAnchor.click();
        downloadAnchor.remove();
        
        showNotification('Project saved successfully!');
        
    } catch (error) {
        showNotification('Error saving project: ' + error.message, 'error');
    } finally {
        const button = getElement('saveProjectBtn');
        button.classList.remove('loading');
        button.disabled = false;
    }
}

function loadProjectFromJSON(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file
    if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
        showNotification('Please select a valid JSON file.', 'error');
        event.target.value = '';
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) { // 5MB limit
        showNotification('File size too large. Please select a file smaller than 5MB.', 'error');
        event.target.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const projectData = JSON.parse(e.target.result);
            
            // Restore project information
            getElement('projectName').value = sanitize(projectData.projectName || '');
            getElement('clientName').value = sanitize(projectData.clientName || '');
            getElement('projectLocation').value = sanitize(projectData.location || '');
            getElement('preparedBy').value = sanitize(projectData.preparedBy || '');
            
            // Restore code standard and units
            if (projectData.codeStandard) {
                getElement('codeStandard').value = projectData.codeStandard;
                currentCodeStandard = projectData.codeStandard;
            }
            if (projectData.units) {
                getElement('units').value = projectData.units;
                currentUnits = projectData.units;
            }
            
            updateCodeStandard();
            updateUnits();
            
            // Restore design results
            if (projectData.designResults) {
                designResults = projectData.designResults;
            }
            
            showNotification('Project loaded successfully!');
        } catch (error) {
            showNotification('Error loading project: Invalid file format or corrupted data.', 'error');
        }
    };
    
    reader.onerror = function() {
        showNotification('Error reading file. Please try again.', 'error');
    };
    
    reader.readAsText(file);
    
    // Reset file input
    event.target.value = '';
}

function resetCalculator() {
    if (confirm('Are you sure you want to reset all calculations? This action cannot be undone.')) {
        // Reset project info
        getElement('projectName').value = 'Commercial Building Plumbing Design';
        getElement('clientName').value = 'ABC Development Corporation';
        getElement('projectLocation').value = 'Manila, Philippines';
        getElement('preparedBy').value = 'Juan Dela Cruz, Plumbing Engineer';
        
        // Reset code standard and units
        getElement('codeStandard').value = 'rnpcp';
        getElement('units').value = 'metric';
        currentCodeStandard = 'rnpcp';
        currentUnits = 'metric';
        updateCodeStandard();
        updateUnits();
        
        // Reset all outputs
        document.querySelectorAll('.output').forEach(output => {
            output.style.display = 'none';
            output.innerHTML = '';
        });
        
        // Reset design results
        designResults = {};
        
        showNotification('Calculator has been reset to default values.');
    }
}

async function generateDesignSummary() {
    try {
        const button = getElement('summaryBtn');
        button.classList.add('loading');
        button.disabled = true;
        
        const output = getElement('designSummaryOutput');
        let summaryHTML = '<h4>Design Summary</h4>';
        
        if (Object.keys(designResults).length === 0) {
            summaryHTML += '<div class="empty-summary">No calculations have been performed yet. Please use the calculators above to generate results.</div>';
        } else {
            summaryHTML += '<div class="summary-grid">';
            
            // Water System Design Results
            if (designResults.waterSupply || designResults.tankSize || designResults.boosterPump || designResults.hotWater) {
                summaryHTML += `
                    <div class="summary-section">
                        <h5>üö∞ Water System Design</h5>
                        <div class="summary-grid">
                `;
                
                if (designResults.waterSupply) {
                    summaryHTML += `
                        <div class="summary-item">
                            <div class="summary-category">${designResults.waterSupply.systemType}</div>
                            <p><strong>Application:</strong> ${designResults.waterSupply.application}</p>
                            <p><strong>Peak Flow:</strong> ${formatNumber(designResults.waterSupply.peakFlow)} ${designResults.waterSupply.flowUnit}</p>
                            <p><strong>Pipe Size:</strong> ${formatPipeSize(designResults.waterSupply.pipeSize)}</p>
                            <p><strong>Available Pressure:</strong> ${formatNumber(designResults.waterSupply.availablePressure)} ${designResults.waterSupply.pressureUnit}</p>
                        </div>
                    `;
                }
                
                if (designResults.tankSize) {
                    summaryHTML += `
                        <div class="summary-item">
                            <div class="summary-category">${designResults.tankSize.systemType}</div>
                            <p><strong>Application:</strong> ${designResults.tankSize.application}</p>
                            <p><strong>Total Capacity:</strong> ${formatNumber(designResults.tankSize.totalStorage)} ${designResults.tankSize.storageUnit}</p>
                            <p><strong>Domestic Storage:</strong> ${formatNumber(designResults.tankSize.domesticStorage)} ${designResults.tankSize.storageUnit}</p>
                            <p><strong>Fire Reserve:</strong> ${formatNumber(designResults.tankSize.fireReserve)} ${currentUnits === 'metric' ? 'L' : 'gal'}</p>
                        </div>
                    `;
                }
                
                if (designResults.boosterPump) {
                    summaryHTML += `
                        <div class="summary-item">
                            <div class="summary-category">${designResults.boosterPump.systemType}</div>
                            <p><strong>Application:</strong> ${designResults.boosterPump.application}</p>
                            <p><strong>TDH:</strong> ${formatNumber(designResults.boosterPump.tdh)} ${designResults.boosterPump.tdhUnit}</p>
                            <p><strong>Flow:</strong> ${formatNumber(designResults.boosterPump.flow)} ${designResults.boosterPump.flowUnit}</p>
                            <p><strong>Power:</strong> ${formatNumber(designResults.boosterPump.powerKW)} kW</p>
                        </div>
                    `;
                }
                
                if (designResults.hotWater) {
                    summaryHTML += `
                        <div class="summary-item">
                            <div class="summary-category">${designResults.hotWater.systemType}</div>
                            <p><strong>Application:</strong> ${designResults.hotWater.application}</p>
                            <p><strong>Peak Flow:</strong> ${formatNumber(designResults.hotWater.peakHotFlow)} ${designResults.hotWater.flowUnit}</p>
                            <p><strong>Simultaneous Fixtures:</strong> ${designResults.hotWater.simultaneousFixtures}</p>
                        </div>
                    `;
                }
                
                summaryHTML += '</div></div>';
            }
            
            // Drainage System Results
            if (designResults.sewer || designResults.storm || designResults.septic || designResults.greaseTrap) {
                summaryHTML += `
                    <div class="summary-section">
                        <h5>üöΩ Drainage & Sanitary Systems</h5>
                        <div class="summary-grid">
                `;
                
                if (designResults.sewer) {
                    summaryHTML += `
                        <div class="summary-item">
                            <div class="summary-category">${designResults.sewer.systemType}</div>
                            <p><strong>Application:</strong> ${designResults.sewer.application}</p>
                            <p><strong>DFU:</strong> ${designResults.sewer.dfu}</p>
                            <p><strong>Equivalent Flow:</strong> ${formatNumber(designResults.sewer.equivalentFlow)} ${designResults.sewer.flowUnit}</p>
                            <p><strong>Pipe Size:</strong> ${formatPipeSize(designResults.sewer.pipeSize)}</p>
                        </div>
                    `;
                }
                
                if (designResults.storm) {
                    summaryHTML += `
                        <div class="summary-item">
                            <div class="summary-category">${designResults.storm.systemType}</div>
                            <p><strong>Application:</strong> ${designResults.storm.application}</p>
                            <p><strong>Peak Flow:</strong> ${formatNumber(designResults.storm.peakFlow)} ${designResults.storm.flowUnit}</p>
                            <p><strong>Roof Area:</strong> ${formatNumber(designResults.storm.area)} ${designResults.storm.areaUnit}</p>
                            <p><strong>Rain Intensity:</strong> ${formatNumber(designResults.storm.intensity)} ${designResults.storm.intensityUnit}</p>
                        </div>
                    `;
                }
                
                if (designResults.septic) {
                    summaryHTML += `
                        <div class="summary-item">
                            <div class="summary-category">${designResults.septic.systemType}</div>
                            <p><strong>Application:</strong> ${designResults.septic.application}</p>
                            <p><strong>Tank Volume:</strong> ${formatNumber(designResults.septic.tankVolume)} ${designResults.septic.volumeUnit}</p>
                            <p><strong>Daily Flow:</strong> ${formatNumber(designResults.septic.dailyFlow)} ${currentUnits === 'metric' ? 'L/day' : 'gal/day'}</p>
                            <p><strong>Retention Time:</strong> ${designResults.septic.retentionTime} hours</p>
                        </div>
                    `;
                }
                
                if (designResults.greaseTrap) {
                    summaryHTML += `
                        <div class="summary-item">
                            <div class="summary-category">${designResults.greaseTrap.systemType}</div>
                            <p><strong>Application:</strong> ${designResults.greaseTrap.application}</p>
                            <p><strong>Trap Volume:</strong> ${formatNumber(designResults.greaseTrap.volume)} ${designResults.greaseTrap.volumeUnit}</p>
                            <p><strong>Fixture Type:</strong> ${designResults.greaseTrap.fixtureType}</p>
                            <p><strong>Flow Rate:</strong> ${formatNumber(designResults.greaseTrap.flow)} ${currentUnits === 'metric' ? 'L/s' : 'gpm'}</p>
                        </div>
                    `;
                }
                
                summaryHTML += '</div></div>';
            }
            
            // Pump System Results
            if (designResults.boosterPump2 || designResults.sumpPump || designResults.firePump || designResults.rainwaterPump) {
                summaryHTML += `
                    <div class="summary-section">
                        <h5>‚ö° Pump Systems</h5>
                        <div class="summary-grid">
                `;
                
                if (designResults.boosterPump2) {
                    summaryHTML += `
                        <div class="summary-item">
                            <div class="summary-category">${designResults.boosterPump2.systemType}</div>
                            <p><strong>Application:</strong> ${designResults.boosterPump2.application}</p>
                            <p><strong>TDH:</strong> ${formatNumber(designResults.boosterPump2.tdh)} ${designResults.boosterPump2.tdhUnit}</p>
                            <p><strong>Flow:</strong> ${formatNumber(designResults.boosterPump2.flow)} ${designResults.boosterPump2.flowUnit}</p>
                            <p><strong>Power:</strong> ${formatNumber(designResults.boosterPump2.powerKW)} kW</p>
                        </div>
                    `;
                }
                
                if (designResults.sumpPump) {
                    summaryHTML += `
                        <div class="summary-item">
                            <div class="summary-category">${designResults.sumpPump.systemType}</div>
                            <p><strong>Application:</strong> ${designResults.sumpPump.application}</p>
                            <p><strong>Flow:</strong> ${formatNumber(designResults.sumpPump.flow)} ${designResults.sumpPump.flowUnit}</p>
                            <p><strong>Head:</strong> ${formatNumber(designResults.sumpPump.head)} ${designResults.sumpPump.headUnit}</p>
                            <p><strong>Power:</strong> ${formatNumber(designResults.sumpPump.powerKW)} kW</p>
                        </div>
                    `;
                }
                
                if (designResults.firePump) {
                    summaryHTML += `
                        <div class="summary-item">
                            <div class="summary-category">${designResults.firePump.systemType}</div>
                            <p><strong>Application:</strong> ${designResults.firePump.application}</p>
                            <p><strong>Flow:</strong> ${formatNumber(designResults.firePump.flow)} ${designResults.firePump.flowUnit}</p>
                            <p><strong>TDH:</strong> ${formatNumber(designResults.firePump.tdh)} ${designResults.firePump.tdhUnit}</p>
                            <p><strong>Power:</strong> ${formatNumber(designResults.firePump.powerKW)} kW</p>
                        </div>
                    `;
                }
                
                if (designResults.rainwaterPump) {
                    summaryHTML += `
                        <div class="summary-item">
                            <div class="summary-category">${designResults.rainwaterPump.systemType}</div>
                            <p><strong>Application:</strong> ${designResults.rainwaterPump.application}</p>
                            <p><strong>Flow:</strong> ${formatNumber(designResults.rainwaterPump.flow)} ${designResults.rainwaterPump.flowUnit}</p>
                            <p><strong>TDH:</strong> ${formatNumber(designResults.rainwaterPump.tdh)} ${designResults.rainwaterPump.tdhUnit}</p>
                            <p><strong>Power:</strong> ${formatNumber(designResults.rainwaterPump.powerKW)} kW</p>
                        </div>
                    `;
                }
                
                summaryHTML += '</div></div>';
            }
            
            // Special Systems Results
            if (designResults.fireDemand || designResults.rainwaterTank || designResults.stpVolume) {
                summaryHTML += `
                    <div class="summary-section">
                        <h5>üöí Special Systems</h5>
                        <div class="summary-grid">
                `;
                
                if (designResults.fireDemand) {
                    summaryHTML += `
                        <div class="summary-item">
                            <div class="summary-category">${designResults.fireDemand.systemType}</div>
                            <p><strong>Application:</strong> ${designResults.fireDemand.application}</p>
                            <p><strong>Total Flow:</strong> ${formatNumber(designResults.fireDemand.totalFlow)} ${designResults.fireDemand.flowUnit}</p>
                            <p><strong>Total Volume:</strong> ${formatNumber(designResults.fireDemand.totalVolume)} ${designResults.fireDemand.volumeUnit}</p>
                        </div>
                    `;
                }
                
                if (designResults.rainwaterTank) {
                    summaryHTML += `
                        <div class="summary-item">
                            <div class="summary-category">${designResults.rainwaterTank.systemType}</div>
                            <p><strong>Application:</strong> ${designResults.rainwaterTank.application}</p>
                            <p><strong>Tank Size:</strong> ${formatNumber(designResults.rainwaterTank.tankSize)} ${designResults.rainwaterTank.storageUnit}</p>
                            <p><strong>Annual Collection:</strong> ${formatNumber(designResults.rainwaterTank.annualCollection)} ${designResults.rainwaterTank.annualUnit}</p>
                        </div>
                    `;
                }
                
                if (designResults.stpVolume) {
                    summaryHTML += `
                        <div class="summary-item">
                            <div class="summary-category">${designResults.stpVolume.systemType}</div>
                            <p><strong>Application:</strong> ${designResults.stpVolume.application}</p>
                            <p><strong>Volume:</strong> ${formatNumber(designResults.stpVolume.volume)} ${designResults.stpVolume.volumeUnit}</p>
                        </div>
                    `;
                }
                
                summaryHTML += '</div></div>';
            }
            
            summaryHTML += '</div>';
        }
        
        output.innerHTML = summaryHTML;
        output.style.display = 'block';
        
        showNotification('Design summary generated successfully!');
        
    } catch (error) {
        showNotification('Error generating design summary: ' + error.message, 'error');
    } finally {
        const button = getElement('summaryBtn');
        button.classList.remove('loading');
        button.disabled = false;
    }
}

async function exportDesignToPDF() {
    try {
        const button = getElement('pdfBtn');
        button.classList.add('loading');
        button.disabled = true;
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add title
        doc.setFontSize(16);
        doc.text('Plumbing Design Summary', 20, 20);
        
        // Add project information
        doc.setFontSize(12);
        doc.text(`Project: ${sanitize(getElement('projectName').value)}`, 20, 40);
        doc.text(`Client: ${sanitize(getElement('clientName').value)}`, 20, 50);
        doc.text(`Location: ${sanitize(getElement('projectLocation').value)}`, 20, 60);
        doc.text(`Prepared By: ${sanitize(getElement('preparedBy').value)}`, 20, 70);
        doc.text(`Code Standard: ${CODE_STANDARDS[currentCodeStandard].name}`, 20, 80);
        doc.text(`Units: ${currentUnits === 'metric' ? 'Metric' : 'Imperial'}`, 20, 90);
        
        // Add design results if available
        if (Object.keys(designResults).length > 0) {
            let yPosition = 110;
            doc.text('Design Results:', 20, yPosition);
            yPosition += 10;
            
            Object.entries(designResults).forEach(([key, result]) => {
                const summary = generateResultSummary(key, result);
                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 20;
                }
                doc.text(summary, 20, yPosition);
                yPosition += 10;
            });
        } else {
            doc.text('No calculations performed yet.', 20, 110);
        }
        
        // Add timestamp
        doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 280);
        
        // Save the PDF
        doc.save('plumbing_design_summary.pdf');
        
        showNotification('PDF exported successfully!');
        
    } catch (error) {
        showNotification('Error generating PDF: ' + error.message, 'error');
    } finally {
        const button = getElement('pdfBtn');
        button.classList.remove('loading');
        button.disabled = false;
    }
}

async function exportDesignToExcel() {
    try {
        const button = getElement('excelBtn');
        button.classList.add('loading');
        button.disabled = true;
        
        // Create workbook
        const wb = XLSX.utils.book_new();
        
        // Project information sheet
        const projectData = [
            ['Plumbing Design Summary'],
            [],
            ['Project Information'],
            ['Project Name', sanitize(getElement('projectName').value)],
            ['Client Name', sanitize(getElement('clientName').value)],
            ['Location', sanitize(getElement('projectLocation').value)],
            ['Prepared By', sanitize(getElement('preparedBy').value)],
            ['Code Standard', CODE_STANDARDS[currentCodeStandard].name],
            ['Units', currentUnits === 'metric' ? 'Metric' : 'Imperial'],
            ['Generated', new Date().toLocaleString()],
            [],
            ['Design Results']
        ];
        
        // Add design results
        if (Object.keys(designResults).length > 0) {
            projectData.push(['System Type', 'Application', 'Results']);
            Object.entries(designResults).forEach(([key, result]) => {
                projectData.push([
                    result.systemType || key,
                    result.application || 'N/A',
                    generateResultSummary(key, result)
                ]);
            });
        } else {
            projectData.push(['No calculations performed yet.']);
        }
        
        const ws = XLSX.utils.aoa_to_sheet(projectData);
        XLSX.utils.book_append_sheet(wb, ws, 'Design Summary');
        
        // Save the Excel file
        XLSX.writeFile(wb, 'plumbing_design_summary.xlsx');
        
        showNotification('Excel file exported successfully!');
        
    } catch (error) {
        showNotification('Error generating Excel file: ' + error.message, 'error');
    } finally {
        const button = getElement('excelBtn');
        button.classList.remove('loading');
        button.disabled = false;
    }
}

// Helper function to generate result summaries
function generateResultSummary(key, result) {
    const system = SYSTEM_IDENTIFICATIONS[key] || { type: "System" };
    
    switch(key) {
        case 'waterSupply':
            return `${system.type}: Peak Flow: ${formatNumber(result.peakFlow)} ${result.flowUnit}, Pipe: ${formatPipeSize(result.pipeSize)}`;
        case 'tankSize':
            return `${system.type}: Total Capacity: ${formatNumber(result.totalStorage)} ${result.storageUnit}`;
        case 'boosterPump':
            return `${system.type}: TDH: ${formatNumber(result.tdh)} ${result.tdhUnit}, Power: ${formatNumber(result.powerKW)} kW`;
        case 'hotWater':
            return `${system.type}: Peak Hot Flow: ${formatNumber(result.peakHotFlow)} ${result.flowUnit}`;
        case 'sewer':
            return `${system.type}: DFU: ${result.dfu}, Pipe Size: ${formatPipeSize(result.pipeSize)}`;
        case 'storm':
            return `${system.type}: Peak Flow: ${formatNumber(result.peakFlow)} ${result.flowUnit}`;
        case 'septic':
            return `${system.type}: Tank Volume: ${formatNumber(result.tankVolume)} ${result.volumeUnit}`;
        case 'greaseTrap':
            return `${system.type}: Trap Volume: ${formatNumber(result.volume)} ${result.volumeUnit}`;
        case 'boosterPump2':
            return `${system.type}: TDH: ${formatNumber(result.tdh)} ${result.tdhUnit}, Power: ${formatNumber(result.powerKW)} kW`;
        case 'sumpPump':
            return `${system.type}: Flow: ${formatNumber(result.flow)} ${result.flowUnit}, Power: ${formatNumber(result.powerKW)} kW`;
        case 'firePump':
            return `${system.type}: Flow: ${formatNumber(result.flow)} ${result.flowUnit}, Power: ${formatNumber(result.powerKW)} kW`;
        case 'rainwaterPump':
            return `${system.type}: Flow: ${formatNumber(result.flow)} ${result.flowUnit}, Power: ${formatNumber(result.powerKW)} kW`;
        case 'fireDemand':
            return `${system.type}: Total Flow: ${formatNumber(result.totalFlow)} ${result.flowUnit}`;
        case 'rainwaterTank':
            return `${system.type}: Tank Size: ${formatNumber(result.tankSize)} ${result.storageUnit}`;
        case 'stpVolume':
            return `${system.type}: Volume: ${formatNumber(result.volume)} ${result.volumeUnit}`;
        default:
            return `${system.type}: ${JSON.stringify(result)}`;
    }
}

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tabs
    initializeTabs();
    
    // Initialize code standard and units
    updateCodeStandard();
    updateUnits();
    updateDFUTable();
    
    // Set up event listeners for code and unit changes
    getElement('codeStandard').addEventListener('change', updateCodeStandard);
    getElement('units').addEventListener('change', updateUnits);
    getElement('dfuCodeSelect').addEventListener('change', updateDFUTable);
    
    // Set up calculation buttons
    const calculationButtons = {
        'waterSupplyBtn': calculateWaterSupply,
        'tankSizeBtn': calculateTankSize,
        'boosterPumpBtn': calculateBoosterPump,
        'hotWaterBtn': calculateHotWaterDemand,
        'sewerBtn': calculateSewerLoad,
        'stormBtn': calculateStormFlow,
        'septicBtn': calculateSepticTank,
        'greaseBtn': calculateGreaseTrap,
        'boosterBtn2': calculateBoosterPump2,
        'sumpBtn': calculateSumpPump,
        'firePumpBtn': calculateFirePump,
        'rainPumpBtn': calculateRainwaterPump,
        'fireDemandBtn': calculateFireDemand,
        'rainTankBtn': calculateRainwaterTank,
        'stpBtn': calculateSTPVolume
    };
    
    // Attach enhanced handlers
    Object.entries(calculationButtons).forEach(([buttonId, calculationFunction]) => {
        const button = getElement(buttonId);
        if (button) {
            button.addEventListener('click', safeCalculation(calculationFunction, buttonId));
        }
    });
    
    // Set up project management buttons
    getElement('saveProjectBtn').addEventListener('click', saveProjectAsJSON);
    getElement('loadProjectBtn').addEventListener('click', () => getElement('jsonFileInput').click());
    getElement('jsonFileInput').addEventListener('change', loadProjectFromJSON);
    getElement('resetBtn').addEventListener('click', resetCalculator);
    getElement('summaryBtn').addEventListener('click', generateDesignSummary);
    getElement('pdfBtn').addEventListener('click', exportDesignToPDF);
    getElement('excelBtn').addEventListener('click', exportDesignToExcel);
    
    // Auto-save functionality
    let autoSaveTimeout;
    function autoSave() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            const projectData = {
                projectName: getElement('projectName').value,
                clientName: getElement('clientName').value,
                location: getElement('projectLocation').value,
                preparedBy: getElement('preparedBy').value,
                codeStandard: currentCodeStandard,
                units: currentUnits,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('plumbingDesignAutoSave', JSON.stringify(projectData));
        }, 1000);
    }
    
    // Set up auto-save listeners
    document.querySelectorAll('#project input, #project select').forEach(element => {
        element.addEventListener('input', autoSave);
        element.addEventListener('change', autoSave);
    });
    
    // Load auto-saved data if available
    const savedData = localStorage.getItem('plumbingDesignAutoSave');
    if (savedData) {
        try {
            const projectData = JSON.parse(savedData);
            if (confirm('Found auto-saved project data. Would you like to load it?')) {
                getElement('projectName').value = projectData.projectName || '';
                getElement('clientName').value = projectData.clientName || '';
                getElement('projectLocation').value = projectData.location || '';
                getElement('preparedBy').value = projectData.preparedBy || '';
                
                if (projectData.codeStandard) {
                    getElement('codeStandard').value = projectData.codeStandard;
                    currentCodeStandard = projectData.codeStandard;
                }
                if (projectData.units) {
                    getElement('units').value = projectData.units;
                    currentUnits = projectData.units;
                }
                
                updateCodeStandard();
                updateUnits();
                
                showNotification('Auto-saved project data loaded successfully!');
            }
        } catch (error) {
            console.warn('Could not load auto-saved data:', error);
        }
    }
});
</script>
</body>
</html>
